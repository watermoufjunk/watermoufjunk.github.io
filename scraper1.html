<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamBox Browser Explorer</title>
    <!-- Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            margin: 0;
            overflow-x: hidden;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #334155; }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-custom {
            animation: spin 1s linear infinite;
        }

        .min-h-screen {
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        .menu-transition {
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease-in-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;

        // Constants
        const PROXY_URL = 'https://corsproxy.io/?';
        const QUALITY_PARAMS = 'quality%5B%5D=HD&quality%5B%5D=HDRip&quality%5B%5D=SD&country%5B%5D=64&country%5B%5D=3';
        const RECENT_RELEASES_FILTER = '&year%5B%5D=2026&year%5B%5D=2025&year%5B%5D=2024&year%5B%5D=2023&year%5B%5D=2022';
        const TRENDING_WINDOW_FILTER = '&year%5B%5D=2025&year%5B%5D=2024';

        /**
         * Enhanced Icon Component
         * Safely renders Lucide icons in a browser environment using lucide.createElement
         */
        const Icon = ({ name, size = 16, className = "", fill = "none" }) => {
            const containerRef = useRef(null);

            useEffect(() => {
                if (window.lucide && window.lucide.icons && containerRef.current) {
                    // Convert kebab-case to PascalCase
                    const normalizeName = (str) => {
                        const camel = str.replace(/-./g, x => x[1].toUpperCase());
                        return camel.charAt(0).toUpperCase() + camel.slice(1);
                    };

                    const iconKey = normalizeName(name);
                    const iconDef = window.lucide.icons[iconKey] || window.lucide.icons[name];

                    // Clear previous content
                    containerRef.current.innerHTML = '';

                    if (iconDef) {
                        try {
                            const svgElement = window.lucide.createElement(iconDef);
                            svgElement.setAttribute('width', size);
                            svgElement.setAttribute('height', size);
                            if (className) svgElement.setAttribute('class', className);
                            svgElement.setAttribute('fill', fill);
                            svgElement.setAttribute('stroke-width', 2);
                            
                            containerRef.current.appendChild(svgElement);
                        } catch (e) {
                            // Silent fail for icon rendering
                        }
                    }
                }
            }, [name, size, className, fill]);

            return <span ref={containerRef} className="inline-flex items-center justify-center shrink-0" style={{ width: size, height: size }}></span>;
        };

        const YEARS = [
            { id: 'all', name: 'All Years', icon: 'history' },
            { id: '2026', name: '2026' },
            { id: '2025', name: '2025' },
            { id: '2024', name: '2024' },
            { id: '2023', name: '2023' },
            { id: '2022', name: '2022' },
            { id: '2021', name: '2021' },
            { id: '2020', name: '2020' },
            { id: '2019', name: '2019' },
        ];

        const GENRES = [
            { id: 'all', name: 'All Genres', icon: 'layers' },
            { id: '14', name: 'Action', icon: 'zap' },
            { id: '109', name: 'Adventure', icon: 'map' },
            { id: '1', name: 'Comedy', icon: 'smile' },
            { id: '12', name: 'Drama', icon: 'theater' },
            { id: '27', name: 'Horror', icon: 'ghost' },
            { id: '162', name: 'Sci-Fi', icon: 'rocket' },
        ];

        const SORTS = [
            { id: 'latest', name: 'Latest', icon: 'clock' },
            { id: 'trending', name: 'Trending', icon: 'trending-up' },
            { id: 'release_date', name: 'Release Date', icon: 'calendar' },
            { id: 'added_date', name: 'Added Date', icon: 'plus-circle' },
            { id: 'imdb_rating', name: 'IMDb Score', icon: 'star' },
        ];

        const MAIN_CATEGORIES = [
            { id: 'movie', name: 'Movies', icon: 'film' },
            { id: 'tv', name: 'TV Shows', icon: 'tv' },
            { id: 'all', name: 'All Content', icon: 'globe' },
        ];

        const ITEM_SELECTORS = ['.movie-cards .item', '.flw-item'];

        const App = () => {
            const [activeMain, setActiveMain] = useState(MAIN_CATEGORIES[0]);
            const [activeSort, setActiveSort] = useState(SORTS[0]);
            const [activeGenre, setActiveGenre] = useState(GENRES[0]);
            const [activeYears, setActiveYears] = useState(['all']);
            const [isStackMode, setIsStackMode] = useState(false);
            
            const [showGenreMenu, setShowGenreMenu] = useState(false);
            const [showYearMenu, setShowYearMenu] = useState(false);
            
            // Base URL and Scraper Configuration
            const [baseUrl, setBaseUrl] = useState('');
            const [showUrlPrompt, setShowUrlPrompt] = useState(true);
            const [isAdvancedVisible, setIsAdvancedVisible] = useState(false);
            const [tempUrl, setTempUrl] = useState(new URLSearchParams(window.location.search).get('api') || '');

            // Search State
            const [searchInput, setSearchInput] = useState('');
            const [activeSearch, setActiveSearch] = useState('');

            // Scraper Selectors State
            const [selectors, setSelectors] = useState({
                item: '.movie-cards .item, .flw-item, .item',
                title: '.title, .film-name a, h3, h2',
                poster: 'img.lazyload, img.film-poster-img, .poster img, img',
                link: 'a'
            });

            const [movies, setMovies] = useState([]);
            const [loading, setLoading] = useState(false);
            const [loadingNextPage, setLoadingNextPage] = useState(false);
            const [page, setPage] = useState(1);
            const [hasMore, setHasMore] = useState(true);
            const [error, setError] = useState(null);
            const [selectedMovie, setSelectedMovie] = useState(null);
            const [modalData, setModalData] = useState(null);
            const [isModalLoading, setIsModalLoading] = useState(false);
            const [currentEndpoint, setCurrentEndpoint] = useState('');
            
            // Debug State
            const [debugLogs, setDebugLogs] = useState([]);
            const [showDebug, setShowDebug] = useState(false);
            
            const preloadTriggerRef = useRef(null);
            const scrollObserver = useRef(null);

            const showYearFilter = activeSort.id !== 'latest' && activeSort.id !== 'release_date';

            // Function to reset other filters when switching modes
            const handleCategoryChange = (category) => {
                setActiveMain(category);
                setActiveSearch(''); // Clear search when browsing categories
                setSearchInput('');
            };

            const handleSortChange = (sort) => {
                setActiveSort(sort);
            };

            const handleGenreChange = (genre) => {
                setActiveGenre(genre);
            };

            const handleSearchSubmit = (e) => {
                if (e.key === 'Enter') {
                    setActiveSearch(searchInput);
                    setPage(1);
                    // Force refresh with new search logic handled in getActiveUrl
                }
            };

            const getActiveUrl = useCallback((pageNum = 1) => {
                if (!baseUrl) return '';

                // Search Mode logic
                if (activeSearch) {
                    const formattedTerm = activeSearch.trim().replace(/\s+/g, '+');
                    return `${baseUrl}/browser?keyword=${formattedTerm}&page=${pageNum}`;
                }

                // Standard Browsing Mode logic
                let url = `${baseUrl}/browser?${QUALITY_PARAMS}`;
                
                if (activeMain.id === 'movie') url += '&type%5B%5D=movie';
                if (activeMain.id === 'tv') url += '&type%5B%5D=tv';

                if (showYearFilter && activeYears.length > 0 && !activeYears.includes('all')) {
                    activeYears.forEach(year => { url += `&year%5B%5D=${year}`; });
                } else {
                    if (activeSort.id === 'trending') {
                        url += TRENDING_WINDOW_FILTER;
                    } else if (activeSort.id === 'latest' || activeSort.id === 'added_date') {
                        if (activeMain.id === 'movie') url += RECENT_RELEASES_FILTER;
                    }
                }

                if (activeSort.id === 'trending') { url += `&sort=trending`; } 
                else if (activeSort.id === 'release_date') { url += '&sort=release_date'; } 
                else if (activeSort.id === 'added_date') { url += '&sort=added_date'; } 
                else if (activeSort.id === 'imdb_rating') { url += '&sort=imdb'; } 
                else { url += '&sort=updated_date'; }

                if (activeGenre.id !== 'all') { url += `&genre%5B%5D=${activeGenre.id}`; }
                if (pageNum > 1) url += `&page=${pageNum}`;
                
                return url;
            }, [activeMain, activeSort, activeGenre, activeYears, baseUrl, showYearFilter, activeSearch]);

            const fetchMovies = useCallback(async (isInitial = true) => {
                if (!baseUrl) return;

                const pageToFetch = isInitial ? 1 : page + 1;
                const targetUrl = getActiveUrl(pageToFetch);
                setCurrentEndpoint(targetUrl);

                if (isInitial) {
                    setLoading(true);
                    setPage(1);
                    setHasMore(true);
                    setDebugLogs([]);
                } else {
                    setLoadingNextPage(true);
                }
                
                setError(null);
                
                try {
                    const response = await fetch(PROXY_URL + encodeURIComponent(targetUrl));
                    if (!response.ok) throw new Error('Network Error');
                    const html = await response.text();
                    
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    let movieElements = [];

                    const itemSelectorList = selectors.item.split(',').map(s => s.trim());
                    for (const s of itemSelectorList) {
                        const found = doc.querySelectorAll(s);
                        if (found.length > 0) {
                            movieElements = Array.from(found);
                            break;
                        }
                    }

                    const extracted = movieElements.map(el => {
                        const titleEl = el.querySelector(selectors.title) || el.querySelector('a') || el.querySelector('h3');
                        if (!titleEl) return null;
                        const title = titleEl.textContent.trim() || titleEl.getAttribute('title');
                        
                        const linkEl = el.querySelector(selectors.link) || el.querySelector('a');
                        const path = linkEl ? linkEl.getAttribute('href') : null;
                        const link = path ? (path.startsWith('http') ? path : `${baseUrl}${path.startsWith('/') ? '' : '/'}${path}`) : '#';
                        
                        const img = el.querySelector(selectors.poster) || el.querySelector('img');
                        const imageUrl = img ? (img.getAttribute('data-src') || img.getAttribute('src')) : null;
                        
                        return { title, link, imageUrl };
                    }).filter(Boolean);

                    const logEntry = {
                        timestamp: new Date().toLocaleTimeString(),
                        page: pageToFetch,
                        url: targetUrl,
                        itemsCount: extracted.length,
                        data: extracted
                    };
                    setDebugLogs(prev => [...prev, logEntry]);

                    if (isInitial) {
                        setMovies(extracted);
                    } else {
                        setMovies(prev => {
                            const existingLinks = new Set(prev.map(m => m.link));
                            const freshItems = extracted.filter(m => !existingLinks.has(m.link));
                            return [...prev, ...freshItems];
                        });
                        setPage(pageToFetch);
                    }
                    if (extracted.length < 5) setHasMore(false);
                } catch (err) {
                    setError(err.message);
                    setDebugLogs(prev => [...prev, { timestamp: new Date().toLocaleTimeString(), error: err.message, url: targetUrl }]);
                } finally {
                    setLoading(false);
                    setLoadingNextPage(false);
                }
            }, [getActiveUrl, page, baseUrl, selectors]);

            useEffect(() => {
                if (scrollObserver.current) scrollObserver.current.disconnect();
                scrollObserver.current = new IntersectionObserver((entries) => {
                    if (entries[0].isIntersecting && hasMore && !loading && !loadingNextPage) {
                        fetchMovies(false);
                    }
                }, { rootMargin: '1200px 0px', threshold: 0 });

                if (preloadTriggerRef.current) scrollObserver.current.observe(preloadTriggerRef.current);
                return () => scrollObserver.current?.disconnect();
            }, [hasMore, loading, loadingNextPage, fetchMovies, movies.length]);

            const handleSaveUrl = useCallback((urlToSave) => {
                const finalUrl = urlToSave || tempUrl;
                if (!finalUrl) return;

                let formattedUrl = finalUrl.trim();
                if (formattedUrl && !formattedUrl.startsWith('http')) {
                    formattedUrl = 'https://' + formattedUrl;
                }
                if (formattedUrl.endsWith('/')) {
                    formattedUrl = formattedUrl.slice(0, -1);
                }
                setBaseUrl(formattedUrl);
                setShowUrlPrompt(false);
            }, [tempUrl]);

            useEffect(() => {
                const apiParam = new URLSearchParams(window.location.search).get('api');
                if (apiParam) {
                    handleSaveUrl(apiParam);
                }
            }, [handleSaveUrl]);

            // Trigger fetch on filter change OR search trigger
            useEffect(() => { 
                if (baseUrl) fetchMovies(true); 
            }, [activeMain, activeSort, activeGenre, activeYears, baseUrl, activeSearch]);

            const handleYearToggle = (yearId) => {
                if (yearId === 'all') { setActiveYears(['all']); return; }
                if (!isStackMode) { setActiveYears([yearId]); return; }
                let nextYears = [...activeYears].filter(y => y !== 'all');
                if (nextYears.includes(yearId)) {
                    nextYears = nextYears.filter(y => y !== yearId);
                    if (nextYears.length === 0) nextYears = ['all'];
                } else { nextYears.push(yearId); }
                setActiveYears(nextYears);
            };

            const fetchMovieDetails = async (movieUrl) => {
                setIsModalLoading(true);
                setModalData(null);
                try {
                    const proxied = PROXY_URL + encodeURIComponent(movieUrl);
                    const html = await fetch(proxied).then(r => r.text());
                    const doc = new DOMParser().parseFromString(html, "text/html");
                    const data = {
                        title: doc.querySelector("h1.title, h1")?.textContent.trim(),
                        description: doc.querySelector(".description, .plot, p")?.textContent.trim(),
                        imdb: doc.querySelector(".IMDb")?.textContent.replace("IMDb", "").trim(),
                        year: doc.querySelector(".metadata span:nth-child(4), .year")?.textContent.trim(),
                        poster: doc.querySelector('img[itemprop="image"], .poster-img, img')?.src
                    };
                    setModalData(data);
                } catch (e) { console.error(e); } finally { setIsModalLoading(false); }
            };

            const copyToClipboard = (text) => {
                const el = document.createElement('textarea');
                el.value = text;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
            };

            return (
                <div className="min-h-screen flex flex-col bg-slate-950 text-slate-100">
                    {/* Setup Prompt Modal */}
                    {showUrlPrompt && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-950/95 backdrop-blur-xl">
                            <div className="bg-slate-900 border border-white/10 p-6 md:p-10 rounded-[2.5rem] shadow-2xl max-w-lg w-full animate-in zoom-in-95 duration-300 overflow-y-auto max-h-[95vh] custom-scrollbar">
                                <div className="flex flex-col items-center text-center mb-8">
                                    <div className="p-4 bg-blue-600 rounded-3xl mb-4 shadow-2xl shadow-blue-600/30">
                                        <Icon name="radio" size={32} className="text-white" />
                                    </div>
                                    <h2 className="text-3xl font-black tracking-tight mb-2">Browser Setup</h2>
                                    <p className="text-slate-400 text-sm">Target any mirror or REST-compatible site with custom scraper settings.</p>
                                </div>
                                
                                <div className="space-y-6">
                                    <div className="space-y-2">
                                        <label className="text-[10px] font-black uppercase tracking-widest text-slate-500 ml-2">Base URL / Endpoint</label>
                                        <div className="relative group">
                                            <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"><Icon name="link" size={16} /></div>
                                            <input type="text" value={tempUrl} onChange={(e) => setTempUrl(e.target.value)} placeholder="https://site-mirror.com" className="w-full bg-slate-800/50 border border-slate-700/50 rounded-2xl py-4 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-600 transition-all text-sm font-medium" />
                                        </div>
                                    </div>

                                    {/* Advanced Settings Toggle */}
                                    <button onClick={() => setIsAdvancedVisible(!isAdvancedVisible)} className="flex items-center gap-2 text-[10px] font-black uppercase text-blue-400 hover:text-blue-300 transition-colors ml-2">
                                        <Icon name={isAdvancedVisible ? "chevron-up" : "chevron-down"} size={14} />
                                        {isAdvancedVisible ? "Hide Advanced Scraper Settings" : "Custom Scraper Selectors"}
                                    </button>

                                    {isAdvancedVisible && (
                                        <div className="space-y-4 p-5 bg-black/30 rounded-3xl border border-white/5 animate-in slide-in-from-top-2 duration-300">
                                            {['item', 'title', 'poster', 'link'].map(key => (
                                                <div key={key} className="space-y-1">
                                                    <label className="text-[9px] font-black uppercase tracking-widest text-slate-600 ml-1">{key} Selector</label>
                                                    <input 
                                                        type="text" 
                                                        value={selectors[key]} 
                                                        onChange={(e) => setSelectors({...selectors, [key]: e.target.value})}
                                                        className="w-full bg-slate-900 border border-slate-800 rounded-xl py-2 px-3 text-xs text-slate-300 focus:outline-none focus:border-blue-500 transition-colors"
                                                    />
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    <button onClick={() => handleSaveUrl()} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-black uppercase text-xs tracking-[0.2em] py-5 rounded-2xl transition-all shadow-2xl shadow-blue-600/20 active:scale-[0.98]">
                                        Initialize Engine
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <header className="sticky top-0 z-50 bg-slate-900/95 backdrop-blur-md border-b border-slate-800 shadow-xl">
                        <div className="px-3 md:px-4 py-2 md:py-3 flex items-center justify-between gap-3 md:gap-4">
                            
                            {/* Logo & Navigation */}
                            <div className="flex items-center gap-6 overflow-x-auto no-scrollbar shrink-0 max-w-[60%] md:max-w-none">
                                <div className="flex items-center gap-2 shrink-0">
                                    <div className="p-1.5 bg-blue-600 rounded-lg shadow-inner shadow-white/10"><Icon name="cpu" className="text-white" size={18} /></div>
                                    <h1 className="text-sm md:text-lg font-black tracking-tighter hidden xs:block uppercase text-white">CORE_STREAM</h1>
                                </div>
                                
                                <nav className="flex items-center gap-2 px-1">
                                    {MAIN_CATEGORIES.map(group => (
                                        <button key={group.id} onClick={() => handleCategoryChange(group)} className={`flex items-center gap-1.5 px-4 py-1.5 rounded-full text-[10px] md:text-xs font-black uppercase transition-all shrink-0 whitespace-nowrap ${activeMain.id === group.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/40' : 'text-slate-500 hover:text-slate-200'}`}>
                                            <Icon name={group.icon} size={12} /> {group.name}
                                        </button>
                                    ))}
                                </nav>
                            </div>

                            {/* Search Bar */}
                            <div className="flex-grow max-w-xs relative group min-w-[120px]">
                                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within:text-blue-400 transition-colors"><Icon name="search" size={16} /></div>
                                <input 
                                    type="text" 
                                    placeholder="Search..." 
                                    value={searchInput}
                                    onChange={(e) => setSearchInput(e.target.value)}
                                    onKeyDown={handleSearchSubmit}
                                    className="w-full bg-slate-800/40 border border-slate-700/50 rounded-full py-1.5 pl-9 pr-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-600/50 transition-all text-xs"
                                />
                            </div>

                            <div className="flex items-center gap-1.5 ml-auto shrink-0">
                                <button onClick={() => setShowDebug(!showDebug)} className={`p-1.5 md:p-2 rounded-full transition-all ${showDebug ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400'}`} title="Debug"><Icon name="terminal" size={14} /></button>
                                <button onClick={() => setShowUrlPrompt(true)} className="p-1.5 md:p-2 bg-slate-800 hover:bg-slate-700 rounded-full text-slate-400" title="Settings"><Icon name="database" size={14} /></button>
                                <button onClick={() => fetchMovies(true)} className="p-1.5 md:p-2 bg-slate-800 hover:bg-slate-700 rounded-full text-slate-400"><Icon name="refresh-cw" className={loading ? "animate-spin-custom" : ""} size={14} /></button>
                            </div>
                        </div>

                        <div className="bg-slate-900/60 border-b border-white/5 py-1.5">
                            <div className="flex items-center gap-3 px-4 overflow-x-auto no-scrollbar">
                                <span className="text-[8px] md:text-[9px] font-black text-slate-600 uppercase tracking-widest shrink-0">Sort:</span>
                                <div className="flex items-center gap-3">
                                    {SORTS.map(sort => (
                                        <button key={sort.id} onClick={() => handleSortChange(sort)} className={`flex items-center gap-1.5 text-[9px] md:text-[10px] font-black uppercase whitespace-nowrap transition-colors ${activeSort.id === sort.id ? 'text-blue-400' : 'text-slate-500'}`}>
                                            <Icon name={sort.icon} size={11} /> {sort.name}
                                            {activeSort.id === sort.id && <div className="w-1 h-1 rounded-full bg-blue-400 ml-0.5" />}
                                        </button>
                                    ))}
                                    <div className="w-[1px] h-3 bg-slate-800 mx-1 shrink-0" />
                                    <button onClick={() => setShowGenreMenu(!showGenreMenu)} className={`flex items-center gap-1.5 text-[9px] md:text-[10px] font-black uppercase whitespace-nowrap transition-colors ${showGenreMenu ? 'text-emerald-400' : 'text-slate-500 hover:text-slate-300'}`}><Icon name="layers" size={11} /> Genre <Icon name="chevron-down" size={10} className={showGenreMenu ? 'rotate-180' : ''} /></button>
                                    {showYearFilter && (
                                        <button onClick={() => setShowYearMenu(!showYearMenu)} className={`flex items-center gap-1.5 text-[9px] md:text-[10px] font-black uppercase whitespace-nowrap transition-colors ${showYearMenu ? 'text-amber-400' : 'text-slate-500 hover:text-slate-300'}`}><Icon name="history" size={11} /> Year <Icon name="chevron-down" size={10} className={showYearMenu ? 'rotate-180' : ''} /></button>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className={`bg-slate-900/40 overflow-hidden menu-transition border-b border-white/5 ${showGenreMenu ? 'max-h-12 opacity-100' : 'max-h-0 opacity-0'}`}>
                            <div className="flex items-center gap-3 px-4 py-1.5 overflow-x-auto no-scrollbar scroll-smooth">
                                <span className="text-[8px] md:text-[9px] font-black text-slate-600 uppercase tracking-widest shrink-0">Genre:</span>
                                <div className="flex gap-4">
                                    {GENRES.map(genre => (
                                        <button key={genre.id} onClick={() => handleGenreChange(genre)} className={`flex items-center gap-1.5 text-[9px] md:text-[10px] font-black uppercase whitespace-nowrap shrink-0 transition-colors ${activeGenre.id === genre.id ? 'text-emerald-400' : 'text-slate-500'}`}>
                                            <Icon name={genre.icon} size={11} /> {genre.name}
                                            {activeGenre.id === genre.id && <div className="w-1 h-1 rounded-full bg-emerald-400 ml-0.5" />}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className={`bg-slate-900/30 border-b border-white/5 menu-transition overflow-hidden ${showYearMenu ? 'max-h-12 opacity-100' : 'max-h-0 opacity-0'}`}>
                            <div className="flex items-center gap-3 px-4 py-1.5 overflow-x-auto no-scrollbar scroll-smooth">
                                <span className="text-[8px] md:text-[9px] font-black text-slate-600 uppercase tracking-widest shrink-0">Year:</span>
                                <div className="flex gap-2">
                                    {YEARS.map(year => (
                                        <button key={year.id} onClick={() => handleYearToggle(year.id)} className={`flex items-center gap-1 px-2.5 py-1 rounded-md text-[9px] md:text-[10px] font-black uppercase transition-all whitespace-nowrap shrink-0 border ${activeYears.includes(year.id) ? 'bg-amber-500/10 text-amber-400 border-amber-500/40 shadow-lg shadow-amber-900/20' : 'bg-slate-800/40 text-slate-500 border-transparent hover:border-slate-600'}`}>
                                            {year.icon && <Icon name={year.icon} size={10} />} {year.name}
                                        </button>
                                    ))}
                                </div>
                                <div className="flex items-center gap-2 shrink-0 ml-auto pl-3 border-l border-slate-800">
                                    <button onClick={() => setIsStackMode(!isStackMode)} className={`flex items-center justify-center w-6 h-6 rounded-md transition-all border ${isStackMode ? 'bg-blue-600 text-white border-blue-400 shadow-lg shadow-blue-900/30' : 'bg-slate-800 text-slate-500 border-slate-700 hover:text-slate-400'}`}>
                                        <Icon name="plus" size={14} className={isStackMode ? "rotate-45 transition-transform" : "transition-transform"} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Debug Inspector */}
                    {showDebug && (
                        <div className="fixed inset-y-0 right-0 w-full max-w-2xl bg-slate-900 z-[60] border-l border-slate-800 shadow-2xl flex flex-col animate-in slide-in-from-right duration-300">
                            <div className="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-950">
                                <div className="flex items-center gap-2">
                                    <Icon name="terminal" size={18} className="text-blue-500" />
                                    <h2 className="text-sm font-black uppercase tracking-widest">API Data Logs</h2>
                                </div>
                                <button onClick={() => setShowDebug(false)} className="p-2 hover:bg-slate-800 rounded-full"><Icon name="x" size={20} /></button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-black font-mono">
                                {debugLogs.length === 0 ? <div className="text-slate-600 italic text-center py-20 text-xs">No requests captured.</div> : debugLogs.map((log, i) => (
                                    <div key={i} className="border border-slate-800 rounded-lg overflow-hidden bg-slate-900/50">
                                        <div className="px-3 py-2 bg-slate-800 flex items-center justify-between gap-2">
                                            <span className="bg-blue-600 text-[10px] px-1.5 py-0.5 rounded font-bold">PAGE {log.page}</span>
                                            <span className="text-[10px] text-slate-400">{log.timestamp}</span>
                                        </div>
                                        <div className="p-3">
                                            <div className="text-[10px] text-blue-400 mb-2 truncate opacity-70">URL: <span className="text-slate-300">{log.url}</span></div>
                                            {log.error ? <div className="text-red-400 text-[10px] font-bold">ERROR: {log.error}</div> : <div className="text-[10px] text-slate-500 mb-2">{log.itemsCount} items</div>}
                                            <pre className="text-[10px] leading-relaxed text-emerald-500/80 overflow-x-auto max-h-48 custom-scrollbar">
                                                {JSON.stringify(log.data, null, 2)}
                                            </pre>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="bg-blue-900/20 border-b border-blue-500/30 px-4 py-1 flex items-center gap-2 overflow-hidden shrink-0">
                        <Icon name="zap" size={10} className="text-blue-400 shrink-0" />
                        <span className="text-[8px] font-mono text-blue-300/70 uppercase font-bold shrink-0">Fetch_Stream:</span>
                        <span className="text-[8px] font-mono text-blue-200 truncate select-all">{currentEndpoint || 'INITIALIZING_CORE...'}</span>
                    </div>

                    <main className="flex-1 p-3 md:p-6 max-w-[1600px] mx-auto w-full">
                        {!baseUrl ? (
                            <div className="flex flex-col items-center justify-center py-48 text-center text-slate-600">
                                <Icon name="power" size={48} className="mb-4 opacity-20" />
                                <p className="text-sm font-bold uppercase tracking-widest italic opacity-40">System Idle: Waiting for Endpoint</p>
                            </div>
                        ) : loading && page === 1 ? (
                            <div className="flex flex-col items-center justify-center py-32 space-y-6 text-center text-white">
                                <Icon name="loader-2" size={40} className="animate-spin-custom text-blue-500" />
                                <p className="text-xs font-black uppercase tracking-widest opacity-60">Scanning Catalog Metadata</p>
                            </div>
                        ) : (
                            <>
                                <div className="flex items-center gap-3 mb-4 md:mb-6 opacity-40">
                                    <div className="h-[2px] w-4 md:w-8 bg-blue-600" />
                                    <h2 className="text-[10px] md:text-xs font-black uppercase tracking-[0.2em] text-slate-500 line-clamp-1">
                                        {activeSearch ? 'SEARCH RESULTS' : `${activeSort.name} / ${activeMain.name} / ${activeGenre.name}`}
                                    </h2>
                                    <span className="text-[9px] font-bold text-slate-700 ml-auto shrink-0">{movies.length} OBJECTS</span>
                                </div>

                                <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-8 2xl:grid-cols-10 gap-2 md:gap-4">
                                    {movies.map((movie, idx) => {
                                        const isTrigger = idx === Math.floor(movies.length / 2) && movies.length > 10;
                                        return (
                                            <div key={`${movie.link}-${idx}`} ref={isTrigger ? preloadTriggerRef : null} className="group bg-slate-900/40 rounded-xl border border-slate-800/30 overflow-hidden hover:border-blue-500/40 transition-all duration-500 hover:-translate-y-1 shadow-sm hover:shadow-2xl hover:shadow-blue-900/20">
                                                <div className="aspect-[2/3] relative overflow-hidden bg-slate-800/40">
                                                    <img src={movie.imageUrl || `https://placehold.co/300x450/0f172a/334155?text=${encodeURIComponent(movie.title)}`} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" loading="lazy" />
                                                    <div className="absolute inset-x-0 bottom-0 p-2 md:p-3 bg-gradient-to-t from-slate-950 via-slate-950/80 to-transparent pointer-events-none">
                                                        <h3 className="font-bold text-[9px] md:text-[11px] text-white leading-tight line-clamp-2 uppercase tracking-tight group-hover:text-blue-400 transition-colors">{movie.title}</h3>
                                                    </div>
                                                    <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-300 bg-slate-950/20 backdrop-blur-[1px]">
                                                        <button onClick={() => { setSelectedMovie(movie); fetchMovieDetails(movie.link); }} className="px-3 md:px-4 py-1 md:py-1.5 bg-white text-slate-950 rounded-full text-[8px] md:text-[10px] font-black uppercase shadow-xl transform translate-y-2 group-hover:translate-y-0 transition-all hover:bg-blue-400 hover:text-white active:scale-95">Inspect</button>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="w-full py-10 flex items-center justify-center">
                                    {loadingNextPage && (
                                        <div className="flex flex-col items-center gap-2">
                                            <Icon name="loader-2" size={24} className="animate-spin-custom text-blue-500" />
                                            <span className="text-[9px] font-black text-slate-500 uppercase tracking-widest">Bridging Buffer...</span>
                                        </div>
                                    )}
                                    {!hasMore && movies.length > 0 && <span className="text-[9px] font-black text-slate-700 uppercase tracking-widest text-white/40">Catalog Terminates Here</span>}
                                </div>
                            </>
                        )}
                    </main>

                    {selectedMovie && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-3 md:p-6 overflow-hidden">
                            <div className="absolute inset-0 bg-slate-950/98 backdrop-blur-xl" onClick={() => setSelectedMovie(null)}/>
                            <div className="relative bg-slate-900 border border-white/5 w-full max-w-3xl max-h-[90vh] rounded-[1.5rem] md:rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col md:flex-row animate-in zoom-in-95 duration-300">
                                <button onClick={() => setSelectedMovie(null)} className="absolute top-4 right-4 md:top-6 md:right-6 z-10 p-2 bg-slate-950/80 hover:bg-red-500/20 text-white rounded-full transition-colors"><Icon name="x" size={18} /></button>
                                {isModalLoading ? (
                                    <div className="w-full h-80 flex items-center justify-center"><Icon name="loader-2" className="animate-spin-custom text-blue-500" size={32} /></div>
                                ) : modalData ? (
                                    <>
                                        <div className="w-full md:w-72 shrink-0 h-56 md:h-auto bg-slate-800 relative">
                                            <img src={modalData.poster || selectedMovie.imageUrl} className="w-full h-full object-cover" />
                                            <div className="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent md:hidden" />
                                        </div>
                                        <div className="p-5 md:p-12 flex flex-col overflow-y-auto custom-scrollbar">
                                            <h2 className="text-xl md:text-5xl font-black text-white mb-3 md:mb-6 leading-tight uppercase italic break-words">{modalData.title}</h2>
                                            <div className="flex flex-wrap gap-2 mb-4 md:mb-8">
                                                {modalData.imdb && <span className="bg-amber-500 text-slate-950 px-2.5 py-0.5 md:py-1 rounded-md text-[9px] md:text-[10px] font-black flex items-center gap-1 uppercase shrink-0"><Icon name="star" size={10} fill="currentColor" /> IMDb {modalData.imdb}</span>}
                                                {modalData.year && <span className="bg-slate-800 text-slate-200 px-2.5 py-0.5 md:py-1 rounded-md text-[9px] md:text-[10px] font-black border border-slate-700 shrink-0">{modalData.year}</span>}
                                            </div>
                                            <p className="text-slate-400 leading-relaxed text-xs md:text-sm mb-6 md:mb-8 font-medium">{modalData.description || "Metadata payload empty for this record."}</p>
                                            <div className="mt-auto flex flex-col xs:flex-row gap-3">
                                                <a href={selectedMovie.link} target="_blank" className="flex-1 bg-blue-600 text-white py-3 md:py-4 rounded-xl md:rounded-2xl font-black text-[10px] md:text-xs uppercase flex items-center justify-center gap-2 md:gap-3 hover:bg-blue-500 transition-all shadow-xl active:scale-95">Open Record <Icon name="external-link" size={16} /></a>
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    <div className="w-full h-80 flex flex-col items-center justify-center p-12 text-center">
                                        <Icon name="alert-circle" size={32} className="text-red-500 mb-4" />
                                        <p className="text-sm font-bold opacity-60">Scraper handshake failed.</p>
                                        <a href={selectedMovie.link} target="_blank" className="mt-6 text-blue-400 font-bold uppercase text-xs">Access URL Direct</a>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
