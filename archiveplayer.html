<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archive Explorer - Global</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0b0f1a; color: #f8fafc; overflow-x: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Video Player Styling */
        .player-wrapper {
            position: relative;
            width: 100%;
            background: #000;
            aspect-ratio: 16 / 9;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #1e293b;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .video-js {
            width: 100% !important;
            height: 100% !important;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .global-seekbar-container { height: 10px; background: #1e293b; border-radius: 5px; position: relative; cursor: pointer; border: 1px solid #334155; }
        .global-seekbar-fill { height: 100%; background: linear-gradient(90deg, #2563eb, #60a5fa); border-radius: 5px; width: 0%; transition: width 0.1s linear; }
        
        .seg-btn.active { border-color: #3b82f6; background: rgba(59, 130, 246, 0.2); }
        .network-badge { font-size: 10px; font-weight: 900; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; background: #2563eb; color: white; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header Section -->
    <header class="sticky top-0 z-50 bg-slate-900/95 backdrop-blur-md border-b border-slate-800 p-4">
        <div class="max-w-7xl mx-auto space-y-4">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-3 cursor-pointer" onclick="location.reload()">
                    <div class="bg-blue-600 p-2 rounded-lg"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" class="text-white"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg></div>
                    <h1 class="text-lg font-black tracking-tighter uppercase">ARCHIVE<span class="text-blue-500">EXPLORER</span></h1>
                </div>

                <div class="flex-1 max-w-xl">
                    <input type="text" id="searchInput" placeholder="Search keywords..." onkeydown="if(event.key==='Enter') resetAndSearch()" class="w-full bg-slate-800 border border-slate-700 rounded-full py-2 px-6 focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                </div>

                <div class="flex items-center gap-2">
                    <button id="network-btn" onclick="toggleDropdown()" class="bg-slate-800 border border-slate-700 px-4 py-2 rounded-full text-[11px] font-black uppercase tracking-widest hover:bg-slate-700 transition-all">Channels</button>
                    <button onclick="resetAndSearch()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-full text-[11px] font-black uppercase tracking-widest transition-all">Scan</button>
                </div>
            </div>

            <div class="flex items-center gap-3 bg-black/40 border border-slate-800 px-3 py-1.5 rounded-lg">
                <span class="text-[9px] font-black text-blue-500 uppercase tracking-widest whitespace-nowrap">API URI</span>
                <div id="search-uri-display" class="text-[10px] text-slate-500 mono truncate w-full cursor-all select-all">Awaiting scan...</div>
            </div>
        </div>
        
        <div id="channel-dropdown" class="hidden absolute right-4 top-24 w-64 bg-slate-900 border border-slate-800 rounded-2xl shadow-2xl p-4 z-[60]">
             <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-800">
                <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Filters</span>
                <div class="flex gap-3">
                    <button onclick="setAllChannels(true)" class="text-[9px] font-black text-blue-500 uppercase hover:text-white transition-colors">Select All</button>
                    <button onclick="setAllChannels(false)" class="text-[9px] font-black text-slate-500 uppercase hover:text-white transition-colors">None</button>
                </div>
             </div>
             <div id="network-options-container" class="space-y-1 max-h-64 overflow-y-auto custom-scrollbar"></div>
        </div>
    </header>

    <!-- Search View -->
    <main id="search-view" class="max-w-7xl mx-auto p-6">
        <div id="results-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
        <div id="loader" class="py-20 text-center hidden"><div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-blue-500/20 border-t-blue-500"></div></div>
        <div id="pagination" class="mt-12 flex justify-center hidden">
            <button onclick="loadMore()" class="bg-slate-800 border border-slate-700 px-10 py-3 rounded-xl font-black uppercase text-xs tracking-widest hover:bg-slate-700">Load More Results</button>
        </div>
    </main>

    <!-- Player View -->
    <main id="player-view" class="fixed inset-0 z-[100] bg-slate-950 p-4 md:p-8 overflow-y-auto hidden">
        <div class="max-w-6xl mx-auto">
            <div class="mb-6 flex items-center justify-between">
                <button onclick="closePlayer()" class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors group">
                    <svg class="w-5 h-5 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
                    <span class="text-xs font-black uppercase tracking-widest">Exit Player</span>
                </button>

                <a id="archive-link" target="_blank" class="flex items-center gap-2 text-slate-400 hover:text-blue-400 transition-colors group">
                    <span class="text-xs font-black uppercase tracking-widest">Archive Source Page</span>
                    <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                </a>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-6">
                    <div class="player-wrapper">
                        <video id="main-video" class="video-js vjs-default-skin vjs-big-play-centered" playsinline controls></video>
                    </div>

                    <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 space-y-6">
                        <div class="global-seekbar-container" onclick="handleGlobalSeek(event)">
                            <div id="global-seekbar-fill" class="global-seekbar-fill"></div>
                        </div>

                        <div class="flex flex-col gap-4">
                            <div class="space-y-1">
                                <div class="flex items-baseline gap-3 flex-wrap">
                                    <h2 id="p-title" class="text-2xl font-black text-white uppercase tracking-tight leading-none"></h2>
                                    <span id="p-airtime" class="text-lg font-black text-blue-400 mono italic opacity-80"></span>
                                </div>
                                <div class="flex items-center gap-3 pt-2">
                                    <span id="p-channel-badge" class="network-badge">CHANNEL</span>
                                    <span id="p-date" class="text-sm font-bold text-slate-500 mono">DATE</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-slate-900/50 border border-slate-800 rounded-2xl flex flex-col h-[calc(100vh-280px)] lg:h-[500px]">
                        <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                            <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Jump to Segment</span>
                        </div>
                        <div id="seg-list" class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_SEARCH = 'https://archive.org/advancedsearch.php';
        const API_METADATA = 'https://archive.org/metadata/';
        const DOWNLOAD_BASE = 'https://archive.org/download/';
        const SEG_DUR = 300; 

        const EXCLUDED_PATTERNS = ["BAY AREA", "THE BAY", "ABC7", "NEWS AT"];

        const CHANNEL_MAP = {
            "CNNW": "CNN", "FOXNEWSW": "FOX NEWS", "MSNOW": "MS NOW", "CNBC": "CNBC", "BLOOMBERG": "BLOOMBERG",
            "FBC": "FOX BIZ", "COM": "COMEDY", "KNTV": "NBC", "KGO": "ABC", "KPIX": "CBS", "KQED": "PBS"
        };

        const STATIONS = ["TV-CNNW", "TV-FOXNEWSW", "TV-MSNOW", "TV-CNBC", "TV-BLOOMBERG", "TV-FBC", "TV-COM", "TV-KNTV", "TV-KGO", "TV-KPIX", "TV-KQED"];

        let state = { page: 1, player: null, activeId: null, activeSegments: [], totalDuration: 0, currentSegStart: 0, currentVideoFile: null };

        window.onload = () => {
            initUI();
            initPlayer();
            resetAndSearch();
        };

        function initUI() {
            const container = document.getElementById('network-options-container');
            STATIONS.forEach(s => {
                const label = CHANNEL_MAP[s.replace('TV-', '')] || s;
                const div = document.createElement('label');
                div.className = "flex items-center justify-between p-2 hover:bg-slate-800 rounded-lg cursor-pointer";
                div.innerHTML = `<span class="text-[11px] font-bold text-slate-400 uppercase">${label}</span><input type="checkbox" value="${s}" checked onchange="resetAndSearch()" class="station-checkbox w-4 h-4 accent-blue-600">`;
                container.appendChild(div);
            });
        }

        function setAllChannels(checked) {
            document.querySelectorAll('.station-checkbox').forEach(cb => cb.checked = checked);
            resetAndSearch();
        }

        function initPlayer() {
            state.player = videojs('main-video', { fluid: false, autoplay: false, controls: true, controlBar: { progressControl: false, remainingTimeDisplay: false } });
            state.player.on('timeupdate', () => {
                const cur = state.currentSegStart + state.player.currentTime();
                const pct = (cur / state.totalDuration) * 100;
                const fill = document.getElementById('global-seekbar-fill');
                if (fill) fill.style.width = `${pct}%`;
            });
        }

        function toggleDropdown() { document.getElementById('channel-dropdown').classList.toggle('hidden'); }

        function resetAndSearch() { state.page = 1; search(); }

        function loadMore() { state.page++; search(true); }

        async function search(append = false) {
            const grid = document.getElementById('results-grid');
            const loader = document.getElementById('loader');
            if (!append) grid.innerHTML = '';
            loader.classList.remove('hidden');

            const term = document.getElementById('searchInput').value.trim();
            const selected = Array.from(document.querySelectorAll('.station-checkbox:checked')).map(c => c.value);
            
            if (selected.length === 0) {
                grid.innerHTML = '<div class="col-span-full py-20 text-center text-slate-500 text-sm italic">No channels selected.</div>';
                loader.classList.add('hidden');
                return;
            }

            const apiExclusions = EXCLUDED_PATTERNS.map(p => ` -title:"${p}"`).join("");
            let q = `mediatype:movies AND (${selected.map(s => `collection:${s}`).join(" OR ")}) ${apiExclusions}`;
            if (term) q += ` AND (title:(${term}) OR description:(${term}))`;

            const params = new URLSearchParams({
                q,
                'fl[]': ['identifier', 'title', 'date'],
                sort: 'publicdate desc',
                rows: 50,
                page: state.page,
                output: 'json'
            });

            document.getElementById('search-uri-display').innerText = `${API_SEARCH}?${params}`;

            try {
                const res = await fetch(`${API_SEARCH}?${params}`);
                const data = await res.json();
                renderResults(data.response.docs);
            } catch (e) { console.error(e); } finally { loader.classList.add('hidden'); }
        }

        function parseMetadata(title) {
            const parts = title.split(" : ");
            let show = parts[0] || "Unknown";
            let channel = parts[1] ? (CHANNEL_MAP[parts[1]] || parts[1]) : "TV";
            const rawRemainder = parts.slice(2).join(" : ");
            // Regex to extract time patterns like 10:00am-11:00am
            const timeMatch = title.match(/(\d{1,2}:\d{2}\s?(?:am|pm)\s*-\s*\d{1,2}:\d{2}\s?(?:am|pm))/i);
            const time = timeMatch ? timeMatch[0] : "";
            const date = rawRemainder.replace(time, '').replace(/[-:]/g, '').trim();
            return { show, channel, time, date };
        }

        function renderResults(docs) {
            const grid = document.getElementById('results-grid');
            docs.forEach(doc => {
                const meta = parseMetadata(doc.title);
                const isExcluded = EXCLUDED_PATTERNS.some(p => doc.title.toUpperCase().includes(p));
                if (isExcluded) return;

                const card = document.createElement('div');
                card.className = "group cursor-pointer flex flex-col";
                card.innerHTML = `
                    <div class="relative aspect-video rounded-xl overflow-hidden border border-slate-800 bg-slate-900 shadow-xl">
                        <img src="https://archive.org/services/img/${doc.identifier}" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 group-hover:scale-110 transition-all duration-500" onerror="this.src='https://archive.org/services/img/placeholder'">
                        <div class="absolute top-2 left-2 right-2 flex justify-between items-start pointer-events-none">
                            <span class="network-badge text-[8px]">${meta.channel}</span>
                            <div class="flex flex-col items-end gap-1">
                                <span class="bg-black/70 backdrop-blur-sm px-2 py-0.5 rounded text-[8px] font-black text-white mono uppercase">${meta.date}</span>
                                ${meta.time ? `<span class="bg-blue-600/80 backdrop-blur-sm px-2 py-0.5 rounded text-[8px] font-black text-white mono uppercase">${meta.time}</span>` : ''}
                            </div>
                        </div>
                        <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black via-black/80 to-transparent p-4 pt-10">
                             <h4 class="text-sm font-black text-white uppercase leading-snug tracking-tight line-clamp-2">${meta.show}</h4>
                        </div>
                    </div>
                `;
                card.onclick = () => loadPlayer(doc.identifier, doc.title);
                grid.appendChild(card);
            });
            document.getElementById('pagination').classList.toggle('hidden', docs.length < 10);
        }

        async function loadPlayer(id, fullTitle) {
            state.activeId = id;
            const meta = parseMetadata(fullTitle);
            document.getElementById('player-view').classList.remove('hidden');
            
            document.getElementById('p-title').innerText = meta.show;
            document.getElementById('p-airtime').innerText = meta.time || "N/A";
            document.getElementById('p-channel-badge').innerText = meta.channel;
            document.getElementById('p-date').innerText = meta.date;
            document.getElementById('archive-link').href = `https://archive.org/details/${id}`;

            try {
                const res = await fetch(`${API_METADATA}${id}`);
                const data = await res.json();
                const videoFile = data.files.find(f => f.name.endsWith('.mp4') && !f.name.includes('thumb'));
                if (!videoFile) return;
                state.currentVideoFile = videoFile.name;
                state.totalDuration = parseInt(videoFile.length);
                
                const segList = document.getElementById('seg-list');
                segList.innerHTML = '';
                state.activeSegments = [];
                for (let i = 0; i < state.totalDuration; i += SEG_DUR) {
                    const start = i;
                    const end = Math.min(i + SEG_DUR, state.totalDuration);
                    state.activeSegments.push({ start, end });
                    const btn = document.createElement('button');
                    btn.className = "seg-btn w-full p-3 rounded-xl bg-slate-800/50 border border-slate-800 hover:border-blue-500 text-left transition-all flex justify-between items-center";
                    btn.innerHTML = `<span class="text-xs font-black text-slate-300 mono">${formatHMS(start)}</span>`;
                    btn.onclick = () => playSegment(start, end);
                    segList.appendChild(btn);
                }
                playSegment(0, SEG_DUR);
            } catch (e) { console.error(e); }
        }

        function playSegment(start, end, seek = 0) {
            state.currentSegStart = start;
            const sourceUrl = `${DOWNLOAD_BASE}${state.activeId}/${encodeURIComponent(state.currentVideoFile)}?start=${start}&end=${end}&ignore=x.mp4`;
            state.player.src({ type: 'video/mp4', src: sourceUrl });
            state.player.one('canplay', () => { if (seek) state.player.currentTime(seek); state.player.play(); });
        }

        function handleGlobalSeek(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            const targetTime = state.totalDuration * pct;
            const segIdx = Math.floor(targetTime / SEG_DUR);
            const seg = state.activeSegments[segIdx];
            if (seg) playSegment(seg.start, seg.end, targetTime - seg.start);
        }

        function closePlayer() { state.player.pause(); document.getElementById('player-view').classList.add('hidden'); }

        function formatHMS(s) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = Math.floor(s % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>
