import React, { useState, useRef, useEffect } from 'react';
import { Play, Download, Copy, Loader2, List, Scissors, Clock, SkipForward, SkipBack, MonitorPlay, Captions, CaptionsOff } from 'lucide-react';

const App = () => {
  const [url, setUrl] = useState('https://archive.org/details/CNNW_20220417_140000_Fareed_Zakaria_GPS');
  const [segments, setSegments] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [playlistContent, setPlaylistContent] = useState('');
  const [metadata, setMetadata] = useState(null);
  const [captionUrl, setCaptionUrl] = useState('');
  const [showCaptions, setShowCaptions] = useState(true);
  
  // Player State
  const [currentSegmentIndex, setCurrentSegmentIndex] = useState(0);
  const [isPlaying, setIsPlaying] = useState(false);
  const videoRef = useRef(null);

  const ARCHIVE_BASE = 'https://archive.org/download';
  const SEGMENT_DURATION = 365; // 365 seconds per segment

  const parseArchiveUrl = (inputUrl) => {
    try {
      const urlObj = new URL(inputUrl.trim());
      const parts = urlObj.pathname.split('/');
      const detailsIndex = parts.indexOf('details');
      if (detailsIndex !== -1 && parts[detailsIndex + 1]) {
        return parts[detailsIndex + 1].split('?')[0].split('#')[0];
      }
      return null;
    } catch (e) {
      return null;
    }
  };

  const fetchAndBuildPlaylist = async () => {
    setLoading(true);
    setError('');
    setSegments([]);
    setPlaylistContent('');
    setMetadata(null);
    setCaptionUrl('');
    setCurrentSegmentIndex(0);

    const identifier = parseArchiveUrl(url);
    if (!identifier) {
      setError('Invalid Archive.org URL. Please use a "details" page URL.');
      setLoading(false);
      return;
    }

    try {
      const metaResp = await fetch(`https://archive.org/metadata/${identifier}`);
      if (!metaResp.ok) throw new Error('Failed to fetch metadata from Archive API');
      const metaData = await metaResp.json();
      setMetadata(metaData);

      // Identify video file
      const videoFiles = metaData.files?.filter(f => f.name.endsWith('.mp4') || f.name.endsWith('.mpeg2')) || [];
      const primaryFile = videoFiles.find(f => f.format === 'h.264') || videoFiles[0];
      
      if (!primaryFile) throw new Error('No video files found for this identifier.');

      // Identify caption file (Archive.org usually provides .vtt or .srt)
      const captionFile = metaData.files?.find(f => f.name.endsWith('.vtt')) || 
                          metaData.files?.find(f => f.name.endsWith('_cc.vtt')) ||
                          metaData.files?.find(f => f.name.endsWith('.srt'));
      
      if (captionFile) {
        setCaptionUrl(`${ARCHIVE_BASE}/${identifier}/${captionFile.name}`);
      }

      const totalDuration = parseInt(metaData.metadata?.duration?.[0] || metaData.metadata?.duration || 3600);
      let foundSegments = [];
      let currentStart = 0;

      while (currentStart < totalDuration) {
        const end = Math.min(currentStart + SEGMENT_DURATION, totalDuration);
        foundSegments.push({
          title: `Segment ${foundSegments.length + 1}`,
          start: currentStart,
          end: end,
          duration: end - currentStart,
          url: `${ARCHIVE_BASE}/${identifier}/${primaryFile.name}?start=${currentStart}&end=${end}`
        });
        currentStart += SEGMENT_DURATION;
      }

      setSegments(foundSegments);

      const title = metaData.metadata?.title || identifier;
      let m3u8 = `#EXTM3U\n#PLAYLIST:${title}\n\n`;
      foundSegments.forEach((s) => {
        m3u8 += `#EXTINF:${s.duration.toFixed(2)}, ${title} - ${s.title}\n${s.url}\n\n`;
      });
      setPlaylistContent(m3u8);

    } catch (err) {
      setError(`${err.message}. Please check the URL and try again.`);
    } finally {
      setLoading(false);
    }
  };

  const handleSegmentEnd = () => {
    if (currentSegmentIndex < segments.length - 1) {
      setCurrentSegmentIndex(prev => prev + 1);
    } else {
      setIsPlaying(false);
    }
  };

  const playSegment = (index) => {
    setCurrentSegmentIndex(index);
    setIsPlaying(true);
    if (videoRef.current) {
      videoRef.current.load();
      videoRef.current.play();
    }
  };

  // Effect to ensure captions track is showing if toggled on
  useEffect(() => {
    if (videoRef.current && videoRef.current.textTracks.length > 0) {
      videoRef.current.textTracks[0].mode = showCaptions ? 'showing' : 'hidden';
    }
  }, [showCaptions, currentSegmentIndex, segments]);

  const copyToClipboard = () => {
    const textArea = document.createElement("textarea");
    textArea.value = playlistContent;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
  };

  const downloadPlaylist = () => {
    const blob = new Blob([playlistContent], { type: 'application/x-mpegURL' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${parseArchiveUrl(url) || 'archive'}_365s.m3u8`;
    link.click();
    URL.revokeObjectURL(link.href);
  };

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-900">
      <div className="max-w-7xl mx-auto">
        <header className="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div className="flex items-center gap-3">
            <div className="bg-blue-600 p-2 rounded-lg text-white shadow-lg">
              <MonitorPlay size={28} />
            </div>
            <div>
              <h1 className="text-2xl font-bold text-slate-800 tracking-tight">Archive Continuous Player</h1>
              <p className="text-slate-500 text-sm">Now with auto-captions from Archive.org metadata.</p>
            </div>
          </div>
          {metadata && (
            <div className="text-right hidden md:block border-l-2 pl-4 border-blue-200">
              <div className="text-sm font-bold text-slate-700 truncate max-w-xs">{metadata.metadata.title}</div>
              <div className="text-xs text-slate-400 font-mono italic">{metadata.metadata.date}</div>
            </div>
          )}
        </header>

        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8">
          <div className="flex flex-col md:flex-row gap-3">
            <input
              type="text"
              value={url}
              onChange={(e) => setUrl(e.target.value)}
              placeholder="Archive.org details URL..."
              className="flex-1 px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm"
            />
            <button
              onClick={fetchAndBuildPlaylist}
              disabled={loading}
              className="bg-blue-600 hover:bg-blue-700 text-white font-bold px-8 py-3 rounded-lg shadow-md transition-all flex items-center justify-center gap-2 disabled:bg-blue-400"
            >
              {loading ? <Loader2 className="animate-spin" size={20} /> : <Play size={20} />}
              Load Stream
            </button>
          </div>
          {error && <div className="mt-4 p-3 bg-red-50 text-red-700 text-xs rounded border border-red-100">{error}</div>}
        </div>

        {segments.length > 0 && (
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            {/* Video Player Section */}
            <div className="lg:col-span-8 space-y-4">
              <div className="bg-black rounded-2xl shadow-2xl overflow-hidden aspect-video relative group">
                <video
                  ref={videoRef}
                  src={segments[currentSegmentIndex]?.url}
                  controls
                  autoPlay={isPlaying}
                  onEnded={handleSegmentEnd}
                  className="w-full h-full"
                  onPlay={() => setIsPlaying(true)}
                  onPause={() => setIsPlaying(false)}
                  crossOrigin="anonymous"
                >
                  {captionUrl && (
                    <track 
                      kind="captions" 
                      src={captionUrl} 
                      srcLang="en" 
                      label="English" 
                      default={showCaptions}
                    />
                  )}
                </video>
              </div>
              
              <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <h2 className="text-lg font-bold text-slate-800">
                      {segments[currentSegmentIndex]?.title}
                    </h2>
                    <div className="flex items-center gap-3 mt-1">
                       <p className="text-sm text-slate-500">
                        Current: {Math.floor(segments[currentSegmentIndex]?.start / 60)}m {segments[currentSegmentIndex]?.start % 60}s
                      </p>
                      {captionUrl && (
                        <span className="flex items-center gap-1 text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded border border-emerald-100">
                          <Captions size={12} /> Captions Loaded
                        </span>
                      )}
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <button 
                      onClick={() => setShowCaptions(!showCaptions)}
                      title={showCaptions ? "Turn off captions" : "Turn on captions"}
                      className={`p-2 rounded-lg transition-colors ${showCaptions ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-400'}`}
                    >
                      {showCaptions ? <Captions size={20} /> : <CaptionsOff size={20} />}
                    </button>
                    <button 
                      onClick={() => playSegment(Math.max(0, currentSegmentIndex - 1))}
                      disabled={currentSegmentIndex === 0}
                      className="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg disabled:opacity-30"
                    >
                      <SkipBack size={20} />
                    </button>
                    <button 
                      onClick={() => playSegment(Math.min(segments.length - 1, currentSegmentIndex + 1))}
                      disabled={currentSegmentIndex === segments.length - 1}
                      className="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg disabled:opacity-30"
                    >
                      <SkipForward size={20} />
                    </button>
                  </div>
                </div>

                <div className="flex flex-wrap gap-2 pt-4 border-t border-slate-100">
                  <button onClick={copyToClipboard} className="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-xs font-bold transition-all">
                    <Copy size={14} /> Copy M3U8
                  </button>
                  <button onClick={downloadPlaylist} className="flex items-center gap-2 px-4 py-2 border border-slate-200 hover:bg-slate-50 text-slate-600 rounded-lg text-xs font-bold transition-all">
                    <Download size={14} /> Download Playlist
                  </button>
                </div>
              </div>
            </div>

            {/* Sidebar / Playlist View */}
            <div className="lg:col-span-4">
              <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-[600px]">
                <div className="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                  <span className="font-bold text-slate-700 text-sm">Segment Queue</span>
                  <span className="text-[10px] bg-blue-100 text-blue-700 font-bold px-2 py-0.5 rounded-full">
                    {currentSegmentIndex + 1} / {segments.length}
                  </span>
                </div>
                <div className="overflow-y-auto flex-1 divide-y divide-slate-100">
                  {segments.map((s, idx) => (
                    <button
                      key={idx}
                      onClick={() => playSegment(idx)}
                      className={`w-full text-left p-4 transition-all flex gap-3 items-center ${
                        currentSegmentIndex === idx 
                        ? 'bg-blue-50 border-l-4 border-blue-600' 
                        : 'hover:bg-slate-50 border-l-4 border-transparent'
                      }`}
                    >
                      <div className={`p-2 rounded-full ${currentSegmentIndex === idx ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-400'}`}>
                        {currentSegmentIndex === idx && isPlaying ? <Loader2 size={14} className="animate-spin" /> : <Play size={14} />}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className={`text-xs font-bold truncate ${currentSegmentIndex === idx ? 'text-blue-700' : 'text-slate-700'}`}>
                          {s.title}
                        </div>
                        <div className="text-[10px] text-slate-400 font-mono mt-0.5">
                          {Math.floor(s.start / 60)}m {s.start % 60}s - {Math.floor(s.end / 60)}m {s.end % 60}s
                        </div>
                      </div>
                    </button>
                  ))}
                </div>
              </div>
            </div>

          </div>
        )}
      </div>
    </div>
  );
};

export default App;
