<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archive Explorer & Rebuilder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Player Stylesheets -->
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        
        .player-frame { min-height: 450px; background: #000; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        
        /* Hide native seek bar to force use of our global one */
        .vjs-progress-control { display: none !important; }
        .video-js { width: 100%; height: 100%; }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;  
            overflow: hidden;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        .active-segment-item {
            background: rgba(37, 99, 235, 0.1);
            border-left: 4px solid #3b82f6;
        }

        .global-progress-container {
            height: 8px;
            background: #334155;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }
        .global-progress-fill {
            height: 100%;
            background: #3b82f6;
            width: 0%;
            transition: width 0.1s linear;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen font-sans overflow-x-hidden">

    <!-- Debug Modal -->
    <div id="debugModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4" style="z-index: 2000;">
        <div class="bg-slate-800 border border-slate-700 w-full max-w-5xl h-[85vh] rounded-2xl flex flex-col overflow-hidden shadow-2xl">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-blue-400 text-sm">Metadata Debugger</h3>
                <button onclick="toggleDebug()" class="text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>
            <pre id="debugOutput" class="flex-1 overflow-auto p-4 font-mono text-[11px] text-slate-300 custom-scrollbar whitespace-pre-wrap"></pre>
        </div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-[100] bg-slate-900/95 backdrop-blur-md border-b border-slate-800 p-3 shadow-xl">
        <div class="max-w-[1600px] mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-3 cursor-pointer shrink-0" onclick="showView('search')">
                <div class="bg-blue-600 p-1.5 rounded-lg text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2" ry="2"></rect><path d="M7 2v20M17 2v20M2 12h20"></path></svg>
                </div>
                <h1 class="text-lg font-bold tracking-tight">Archive<span class="text-blue-500">Explorer</span></h1>
            </div>

            <div class="flex flex-1 max-w-5xl w-full items-center gap-3">
                <form id="searchForm" class="relative flex-1">
                    <input type="text" id="searchInput" placeholder="Search Archive..." class="w-full bg-slate-800 border border-slate-700 rounded-full py-2 px-10 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                </form>
                
                <div class="flex items-center gap-2">
                    <select id="sortOption" onchange="currentPage=1; searchArchive(currentQuery)" class="bg-slate-800 border border-slate-700 rounded-full px-3 py-1.5 text-[10px] font-bold focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                        <option value="-publicdate" selected>Newest Archived</option>
                        <option value="publicdate">Oldest Archived</option>
                        <option value="-date">Newest Aired</option>
                        <option value="date">Oldest Aired</option>
                    </select>
                    
                    <button id="comcastFilterBtn" onclick="toggleComcastFilter()" class="bg-slate-800 border border-slate-700 px-3 py-1.5 rounded-full text-[10px] font-bold transition-all">Comcast 2025</button>
                    
                    <button onclick="toggleDebug()" class="p-1.5 bg-slate-800 border border-slate-700 rounded-full text-slate-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Search View -->
    <main id="search-view" class="max-w-[1800px] mx-auto p-4 animate-fade-in">
        <div id="results-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-8 gap-3"></div>
        <div id="pagination" class="mt-10 flex justify-center hidden">
            <button onclick="loadMoreResults()" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-6 py-2 rounded-lg text-xs font-bold">Load More</button>
        </div>
    </main>

    <!-- Player View -->
    <main id="player-view" class="max-w-[1400px] mx-auto p-4 hidden animate-fade-in">
        <div class="flex flex-col lg:grid lg:grid-cols-12 gap-6">
            <div class="lg:col-span-8 space-y-4">
                <!-- Video Core -->
                <div id="player-container" class="bg-black rounded-xl shadow-2xl overflow-hidden aspect-video relative player-frame">
                    <video id="main-video" class="video-js vjs-default-skin w-full h-full" controls crossorigin="anonymous" playsinline></video>
                </div>

                <!-- ULTIMATE SEEK BAR (Global Timeline) -->
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-4 shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <span id="global-time-current" class="text-[11px] font-mono text-blue-400 font-bold">00:00:00</span>
                        <div class="text-[10px] uppercase font-bold text-slate-500 tracking-widest">Global Archive Timeline</div>
                        <span id="global-time-total" class="text-[11px] font-mono text-slate-400">00:00:00</span>
                    </div>
                    
                    <div id="global-seek-bar" class="global-progress-container">
                        <div id="global-progress-fill" class="global-progress-fill"></div>
                    </div>
                    
                    <div class="mt-4 flex flex-col md:flex-row justify-between items-start gap-4">
                        <div class="flex-1 min-w-0">
                            <h2 id="current-title" class="text-base font-bold text-white truncate">Untitled Video</h2>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[9px] text-slate-500 uppercase font-bold">Identifier:</span>
                                <span id="display-identifier" class="text-[9px] text-blue-400 font-mono">Loading...</span>
                            </div>
                        </div>
                        <button onclick="showView('search')" class="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-[10px] font-bold">Close Player</button>
                    </div>
                </div>

                <div id="source-log" class="space-y-1 max-h-24 overflow-y-auto custom-scrollbar text-[9px] bg-slate-950 p-3 rounded-lg font-mono text-slate-500 border border-slate-800"></div>
            </div>

            <!-- Segment Queue Column -->
            <div class="lg:col-span-4 flex flex-col h-full space-y-4">
                <div class="bg-slate-800 border border-slate-700 rounded-xl flex flex-col h-[600px] overflow-hidden shadow-xl">
                    <div class="p-3 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center">
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Segment Queue</h3>
                        <span id="segment-count" class="text-[10px] bg-blue-600 text-white px-2 py-0.5 rounded-full font-bold">0/0</span>
                    </div>
                    <div id="segment-list" class="flex-1 overflow-y-auto custom-scrollbar divide-y divide-slate-700/50"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const ARCHIVE_BASE = 'https://archive.org/download';
        const SEGMENT_DURATION = 360; 
        let player = null;
        let currentPage = 1;
        let currentQuery = "";
        let isComcastOnly = false;
        
        let activeSegments = [];
        let currentSegmentIdx = 0;
        let activeIdentifier = '';
        let activeFileName = '';
        let totalArchiveDuration = 0;

        window.onload = () => {
            player = videojs('main-video', { 
                fluid: true, 
                playbackRates: [0.5, 1, 1.5, 2],
                controlBar: {
                    progressControl: false 
                }
            });

            player.on('ended', () => {
                if (currentSegmentIdx < activeSegments.length - 1) {
                    playSegment(currentSegmentIdx + 1);
                }
            });

            player.on('timeupdate', updateGlobalProgress);
            document.getElementById('global-seek-bar').addEventListener('click', handleGlobalSeek);
            
            // Initial load
            searchArchive("");
        };

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return [h, m, s].map(v => v < 10 ? "0" + v : v).join(":");
        }

        function updateGlobalProgress() {
            if (!totalArchiveDuration) return;
            const currentGlobalTime = activeSegments[currentSegmentIdx].start + player.currentTime();
            const percent = (currentGlobalTime / totalArchiveDuration) * 100;
            document.getElementById('global-progress-fill').style.width = `${percent}%`;
            document.getElementById('global-time-current').textContent = formatTime(currentGlobalTime);
        }

        function handleGlobalSeek(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const width = rect.width;
            const targetTime = (x / width) * totalArchiveDuration;
            const segmentIdx = Math.floor(targetTime / SEGMENT_DURATION);
            const internalOffset = targetTime % SEGMENT_DURATION;

            if (currentSegmentIdx === segmentIdx) {
                player.currentTime(internalOffset);
            } else {
                playSegment(segmentIdx, internalOffset);
            }
        }

        async function prepareVideo(identifier, title) {
            showView('player');
            document.getElementById('current-title').textContent = title;
            document.getElementById('display-identifier').textContent = identifier;
            document.getElementById('source-log').innerHTML = '';
            activeIdentifier = identifier;

            try {
                const response = await fetch(`https://archive.org/metadata/${identifier}`);
                const meta = await response.json();
                const videoFile = (meta.files || []).find(f => f.name.toLowerCase().endsWith('.mp4') && !f.name.includes('ia.mp4')) || (meta.files || []).find(f => f.name.toLowerCase().endsWith('.mp4'));

                if (!videoFile) throw new Error("No video found.");

                activeFileName = videoFile.name;
                totalArchiveDuration = parseInt(meta.metadata.duration || videoFile.length || 3600);
                document.getElementById('global-time-total').textContent = formatTime(totalArchiveDuration);

                activeSegments = [];
                for (let start = 0; start < totalArchiveDuration; start += SEGMENT_DURATION) {
                    const end = Math.min(start + SEGMENT_DURATION, totalArchiveDuration);
                    activeSegments.push({ start, end });
                }

                renderSegmentUI();
                playSegment(0);
            } catch (err) {
                logToPlayer(`Error: ${err.message}`, "text-red-500");
            }
        }

        function playSegment(idx, offset = 0) {
            if (idx >= activeSegments.length) return;
            currentSegmentIdx = idx;
            const seg = activeSegments[idx];
            const url = `${ARCHIVE_BASE}/${activeIdentifier}/${encodeURIComponent(activeFileName)}?start=${seg.start}&end=${seg.end}`;
            
            document.querySelectorAll('[id^="seg-item-"]').forEach(el => el.classList.remove('active-segment-item'));
            document.getElementById(`seg-item-${idx}`)?.classList.add('active-segment-item');
            document.getElementById('segment-count').textContent = `${idx + 1}/${activeSegments.length}`;

            player.src({ src: url, type: 'video/mp4' });
            if (offset > 0) {
                player.one('loadedmetadata', () => { player.currentTime(offset); });
            }
            player.play();
        }

        function renderSegmentUI() {
            const list = document.getElementById('segment-list');
            list.innerHTML = '';
            activeSegments.forEach((seg, idx) => {
                const item = document.createElement('div');
                item.id = `seg-item-${idx}`;
                item.className = 'p-3 cursor-pointer hover:bg-slate-700/50 flex flex-col gap-1 transition-all';
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-slate-300">Chunk ${idx + 1}</span>
                        <span class="text-[9px] font-mono text-slate-500">${formatTime(seg.start)}</span>
                    </div>
                `;
                item.onclick = () => playSegment(idx);
                list.appendChild(item);
            });
        }

        function logToPlayer(msg, colorClass = "text-slate-500") {
            const log = document.getElementById('source-log');
            const d = document.createElement('div');
            d.className = colorClass;
            d.textContent = `[LOG] ${msg}`;
            log.prepend(d);
        }

        function showView(view) {
            document.getElementById('search-view').classList.toggle('hidden', view !== 'search');
            document.getElementById('player-view').classList.toggle('hidden', view !== 'player');
            if (view === 'search' && player) player.pause();
        }

        document.getElementById('searchForm').onsubmit = (e) => {
            e.preventDefault();
            currentPage = 1;
            currentQuery = document.getElementById('searchInput').value;
            searchArchive(currentQuery);
        };

        async function searchArchive(query) {
            showView('search');
            const sortVal = document.getElementById('sortOption').value;
            const activeFilter = isComcastOnly ? 'source:(Comcast) AND date:[2025-01-01 TO 2025-12-31]' : '(collection:TV-*)';
            let fullQuery = query && query.trim() !== "" ? `(${query}) AND ${activeFilter}` : activeFilter;
            
            // Search URL with priority sort
            const url = `https://archive.org/advancedsearch.php?q=${encodeURIComponent(fullQuery)}&fl[]=identifier&fl[]=title&fl[]=date&fl[]=publicdate&sort[]=${sortVal}&output=json&rows=50&page=${currentPage}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                document.getElementById('debugOutput').textContent = JSON.stringify(data, null, 2);
                if (currentPage === 1) document.getElementById('results-grid').innerHTML = '';
                renderResults(data.response.docs);
                document.getElementById('pagination').classList.remove('hidden');
            } catch (e) {}
        }

        function renderResults(items) {
            const grid = document.getElementById('results-grid');
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'result-card relative bg-slate-800 rounded-lg overflow-hidden border border-slate-700 cursor-pointer aspect-video';
                card.innerHTML = `<img src="https://archive.org/services/img/${item.identifier}" class="w-full h-full object-cover opacity-60"><div class="absolute inset-0 p-2 flex flex-col justify-end bg-gradient-to-t from-black/80"><h4 class="text-[10px] font-bold text-white line-clamp-1">${item.title || item.identifier}</h4><div class="text-[8px] text-blue-400 font-mono">Archived: ${(item.publicdate || "").split('T')[0]}</div></div>`;
                card.onclick = () => prepareVideo(item.identifier, item.title);
                grid.appendChild(card);
            });
        }
        function toggleDebug() { document.getElementById('debugModal').classList.toggle('hidden'); }
        function loadMoreResults() { currentPage++; searchArchive(currentQuery); }
        function toggleComcastFilter() { isComcastOnly = !isComcastOnly; searchArchive(currentQuery); }
    </script>
</body>
</html>
