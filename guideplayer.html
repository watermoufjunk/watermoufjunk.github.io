<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live TV Guide</title>
    
    <!-- Core Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' },
                        brand: { 500: '#ef4444', 600: '#dc2626' }
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] }
                }
            }
        }
    </script>

    <style>
        .video-js, .plyr, #clapprContainer, #artContainer, #dplayerContainer, #shakaContainer, .shaka-video-container { width: 100%; height: 100%; border-radius: 0.5rem; overflow: hidden; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.2); opacity: 0; } }
        .live-dot { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); animation: pulse-ring 2s infinite; }
        #videoWrapper:fullscreen { width: 100% !important; height: 100% !important; border-radius: 0; }
        #videoWrapper:fullscreen video { width: 100%; height: 100%; }
        .nav-item:focus { outline: 1.5px solid #ef4444; outline-offset: 2px; z-index: 10; }
        #statsOverlay { pointer-events: none; text-shadow: 1px 1px 2px black; }

        @media (max-width: 640px) {
            #playerContainer { position: fixed !important; top: 2.6rem; right: 0.25rem; width: 200px !important; max-height: 360px; z-index: 50; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.7); border: 1px solid rgba(255, 255, 255, 0.1); }
            .epg-text-box { max-width: calc(100% - 160px); }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 h-screen flex flex-col overflow-hidden font-sans">

    <!-- Compact Navbar -->
    <nav class="sticky top-0 z-40 w-full bg-slate-900/95 backdrop-blur border-b border-slate-800 shadow-lg h-10">
        <div class="w-full px-2 h-full flex items-center gap-3">
            <div id="filterMenu" class="flex-1 flex items-center gap-2 overflow-x-auto hide-scroll py-1">
                <div class="text-[10px] text-slate-500 italic px-2">Loading...</div>
            </div>
            <div class="flex-shrink-0 flex items-center gap-2 border-l border-slate-800 pl-2">
                <button id="searchToggle" onclick="window.toggleSearch()" class="nav-item p-1 text-slate-400 hover:text-white transition-colors rounded">
                    <i class="fa-solid fa-magnifying-glass text-xs"></i>
                </button>
            </div>
        </div>
        <div id="searchContainer" class="hidden bg-slate-800 border-b border-slate-700 p-2 absolute top-10 w-full z-50">
             <div class="max-w-7xl mx-auto">
                <input type="text" id="searchInput" placeholder="Search channels..." class="nav-item w-full bg-slate-900 text-white px-3 py-1.5 text-sm rounded border border-slate-700 focus:outline-none focus:border-brand-500" oninput="window.onSearch(this.value)">
             </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow w-full px-1 md:px-4 py-2 flex flex-row items-start gap-1 md:gap-2 overflow-hidden">
        <div class="flex-1 min-w-0 flex flex-col gap-3 w-full h-full order-1 overflow-y-auto hide-scroll pb-16">
            <div id="list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-2">
                 <div class="flex items-center justify-center p-12 text-slate-600 col-span-full">
                     <i class="fa-solid fa-circle-notch fa-spin text-2xl"></i>
                     <span class="ml-3">Loading Guide...</span>
                 </div>
            </div>
        </div>

        <div id="playerContainer" class="hidden w-[14rem] sm:w-[20rem] lg:w-[22rem] xl:w-[26rem] flex-shrink-0 sticky top-0 animate-fade-in mb-2 transition-all duration-300 max-h-[400px] overflow-y-auto hide-scroll order-2">
            <div class="bg-black/40 backdrop-blur rounded-xl overflow-hidden border border-slate-800/50 shadow-2xl">
                <div class="relative w-full aspect-video bg-black group shrink-0">
                    <div id="videoWrapper" class="w-full h-full relative">
                        <div id="vLoader" class="absolute inset-0 flex items-center justify-center bg-black z-50 text-white font-bold tracking-widest pointer-events-none">
                            <div class="flex flex-col items-center gap-2">
                                <i class="fa-solid fa-circle-notch fa-spin text-2xl text-brand-500"></i>
                                <span class="text-[10px] opacity-70">LOADING...</span>
                            </div>
                        </div>
                    </div>
                    <div id="statsOverlay" class="hidden absolute top-2 left-2 z-50 bg-black/60 p-2 rounded text-[10px] font-mono text-emerald-400 border border-emerald-500/30">
                        <div id="statsContent"></div>
                    </div>
                    <button id="unmutePrompt" onclick="window.unmutePlayer()" class="nav-item hidden absolute bottom-3 right-3 z-50 px-3 py-1.5 bg-black/60 hover:bg-brand-600 text-white text-[10px] font-bold rounded-full backdrop-blur border border-white/10 shadow-lg transition-all animate-bounce flex items-center gap-1.5">
                        <i class="fa-solid fa-volume-high"></i> <span>UNMUTE</span>
                    </button>
                </div>

                <div class="px-3 py-2 bg-slate-900/95 border-t border-slate-800/50">
                    <div class="flex items-start gap-3 mb-2">
                        <div id="playingLogo" class="w-10 h-7 bg-slate-900 rounded flex items-center justify-center overflow-hidden border border-slate-800 shrink-0 hidden p-1"></div>
                        <div class="min-w-0 flex-1">
                             <div class="flex items-center gap-2">
                                 <h2 id="playingTitle" class="text-sm font-bold text-white leading-tight">Select Channel</h2>
                                 <span id="lastEvent" class="font-mono text-[9px] text-slate-400 uppercase border border-slate-700/50 px-1 rounded bg-slate-800/50 shrink-0">IDLE</span>
                             </div>
                        </div>
                    </div>

                    <div class="block">
                        <div class="float-right ml-3 mb-1.5 flex flex-col items-end gap-1.5 shrink-0">
                            <div class="flex flex-wrap items-center justify-end gap-1.5">
                                <select id="playerEngineSelect" onchange="window.changeEngine(this.value)" class="nav-item w-16 bg-slate-800 text-[9px] uppercase font-bold text-slate-400 border border-slate-700/50 rounded px-1 py-0.5 focus:outline-none focus:border-slate-500 truncate appearance-none text-center hover:bg-slate-700 cursor-pointer h-6">
                                    <option value="AUTO">Auto Engine</option>
                                    <optgroup label="Local"><option value="NATIVE">Native</option><option value="HLS.JS">HLS.js</option><option value="VIDEOJS">VideoJS</option><option value="CLAPPR">Clappr</option><option value="ARTPLAYER">Art</option><option value="SHAKA">Shaka</option><option value="DPLAYER">DPlayer</option></optgroup>
                                    <optgroup label="Hosted"><option value="STAND_ALONE">Any Player</option><option value="ANY_CLAPPR">Any:Clp</option><option value="ANY_VIDEOJS">Any:Vjs</option><option value="ANY_JWPLAYER">Any:Jw</option><option value="ANY_FLOWPLAYER">Any:Flw</option><option value="ANY_MEDIAELEMENT">Any:Mel</option><option value="ANY_HLSJS">Any:Hls</option><option value="DEBUG">Debug</option></optgroup>
                                </select>
                                <select id="sourceSelect" onchange="window.handleSourceChange(this.value)" class="nav-item w-14 bg-slate-800 text-[9px] uppercase font-bold text-slate-400 border border-slate-700/50 rounded px-1 py-0.5 focus:outline-none focus:border-slate-500 truncate appearance-none text-center hover:bg-slate-700 cursor-pointer h-6 hidden">
                                </select>
                                <div class="flex items-center bg-slate-800 rounded p-0.5 border border-slate-700/50 h-6">
                                    <div id="mainControls" class="flex items-center">
                                        <button onclick="window.toggleCC()" class="cc-toggle-btn nav-item px-1.5 h-full hover:bg-slate-700 rounded text-slate-300 hover:text-white opacity-50 cursor-not-allowed flex items-center justify-center" title="Captions"><i class="fa-regular fa-closed-captioning text-[9px]"></i></button>
                                        <button onclick="window.togglePlay()" class="play-toggle-btn nav-item px-1.5 h-full hover:bg-slate-700 rounded text-slate-300 hover:text-white flex items-center justify-center" title="Play/Pause"><i class="fa-solid fa-play text-[9px]"></i></button>
                                        <button onclick="window.toggleMute()" class="mute-toggle-btn nav-item px-1.5 h-full hover:bg-slate-700 rounded text-slate-300 hover:text-white flex items-center justify-center" title="Mute"><i class="fa-solid fa-volume-xmark text-[9px]"></i></button>
                                    </div>
                                    <button id="fsBtn" onclick="window.toggleFullscreen()" class="nav-item px-1.5 h-full hover:bg-slate-700 rounded text-slate-300 hover:text-white flex items-center justify-center border-l border-slate-700/50 ml-0.5" title="Fullscreen"><i class="fa-solid fa-expand text-[9px]"></i></button>
                                </div>
                                <div class="flex items-center gap-1 h-6">
                                    <button onclick="window.reloadCurrent()" class="nav-item w-6 h-full bg-slate-800 border border-slate-700/50 rounded hover:bg-slate-700 text-slate-300 flex items-center justify-center" title="Reload"><i class="fa-solid fa-rotate-right text-[9px]"></i></button>
                                    <button onclick="window.closePlayer()" class="nav-item w-6 h-full bg-red-900/20 border border-red-900/30 text-red-400 rounded hover:bg-red-900/40 flex items-center justify-center" title="Close"><i class="fa-solid fa-xmark text-[9px]"></i></button>
                                </div>
                            </div>
                            
                            <!-- Debug Button -->
                            <button id="logToggle" onclick="window.toggleStats()" class="nav-item w-6 h-6 bg-slate-800 border border-slate-700/50 rounded hover:bg-slate-700 text-slate-300 flex items-center justify-center" title="System Logs & Stats"><i class="fa-solid fa-terminal text-[9px]"></i></button>
                        </div>

                        <p id="pd-desc" class="text-[10px] text-slate-500 leading-relaxed"></p>
                        <div id="loadTimeDisplay" class="text-[9px] font-mono text-slate-600 mt-1 italic"></div>
                        <div class="clear-both"></div>
                    </div>
                </div>

                <div id="logPanel" class="hidden px-3 py-2 bg-slate-950 border-t border-slate-800/50">
                    <div class="flex items-center flex-wrap gap-2 mb-2 pb-2 border-b border-slate-800/50">
                        <span class="text-[8px] font-bold text-slate-600 uppercase tracking-widest mr-auto">Debug Tools</span>
                        <div id="hostedControls" class="flex items-center gap-1 mr-2 hidden">
                            <button onclick="window.toggleCC()" class="cc-toggle-btn nav-item p-1.5 bg-slate-850 border border-slate-700 rounded text-slate-400 hover:text-white flex items-center justify-center"><i class="fa-regular fa-closed-captioning text-[9px]"></i></button>
                            <button onclick="window.togglePlay()" class="play-toggle-btn nav-item p-1.5 bg-slate-850 border border-slate-700 rounded text-slate-400 hover:text-white flex items-center justify-center"><i class="fa-solid fa-play text-[9px]"></i></button>
                            <button onclick="window.toggleMute()" class="mute-toggle-btn nav-item p-1.5 bg-slate-850 border border-slate-700 rounded text-slate-400 hover:text-white flex items-center justify-center"><i class="fa-solid fa-volume-xmark text-[9px]"></i></button>
                        </div>
                        <button id="controlsToggle" onclick="window.toggleControls()" class="nav-item p-1.5 bg-slate-800 border border-slate-700/50 rounded text-slate-400 hover:text-white flex items-center justify-center transition-colors" title="Toggle Native Video Controls">
                            <i class="fa-solid fa-sliders text-[9px]"></i>
                        </button>
                        <button onclick="window.openCurrentTab()" class="nav-item p-1.5 bg-slate-800 border border-slate-700/50 rounded text-slate-400 hover:text-white flex items-center justify-center transition-colors" title="Open Stream in New Tab">
                            <i class="fa-solid fa-up-right-from-square text-[9px]"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-2 h-40">
                        <div class="flex flex-col gap-1 min-w-0">
                            <div class="text-[8px] font-bold text-slate-600 uppercase tracking-tighter">Boot Log</div>
                            <div id="bootLog" class="flex-grow font-mono text-[9px] text-slate-500 overflow-y-auto hide-scroll bg-black/40 rounded p-1"></div>
                        </div>
                        <div class="flex flex-col gap-1 min-w-0">
                            <div class="text-[8px] font-bold text-slate-600 uppercase tracking-tighter">Resolution Log</div>
                            <div id="resolutionLog" class="flex-grow font-mono text-[9px] text-emerald-600 overflow-y-auto hide-scroll bg-black/40 rounded p-1"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="fixed bottom-4 left-4 z-50 flex flex-col gap-2 opacity-80 hover:opacity-100 transition-opacity">
        <button onclick="window.scrollList(-1)" class="nav-item p-3 bg-slate-800/90 text-white rounded-full shadow-xl border border-slate-700 backdrop-blur active:scale-95 active:bg-brand-600 transition-all"><i class="fa-solid fa-arrow-up text-sm"></i></button>
        <button onclick="window.scrollList(1)" class="nav-item p-3 bg-slate-800/90 text-white rounded-full shadow-xl border border-slate-700 backdrop-blur active:scale-95 active:bg-brand-600 transition-all"><i class="fa-solid fa-arrow-down text-sm"></i></button>
    </div>

    <footer class="mt-auto border-t border-slate-900 bg-slate-950 p-4 sticky bottom-0 z-30">
        <div class="text-center text-[10px] text-slate-700">
            TV Guide v2.0 â€¢ Press <i class="fa-solid fa-terminal"></i> in player for diagnostic tools
        </div>
    </footer>

    <!-- LOGIC -->
    <script>
        const API_FALLBACKS = {
            metadata_url: 'https://pastebin.com/raw/pPCVY4Vv',
            schedule_url: 'https://tvpass.org/tv_schedules/channels_tv_schedule.json',
            s1_format: 'https://fl1.moveonjoy.com/{slug}/index.m3u8',
            s2_format: 'https://tvpass.org/live/{slug}/sd',
            proxy_url: 'https://anym3u8player.com/ultimate-player-generator/player.php'
        };

        window.onerror = (msg) => { console.error(msg); return true; };

        (async () => {
            const s = id => document.getElementById(id);
            const CACHE_KEY = "epg_metadata_v1", CACHE_TTL = 86400000, CC_PREF_KEY = "epg_cc_enabled", ENGINE_PREF_KEY = "epg_player_engine";
            
            const CONFIG = {
                CLASS: { ACTIVE: 'ring-1 ring-brand-500 bg-slate-800 channel-card-active', RESET: 'bg-slate-850' },
                ICON: {
                    PLAY: '<i class="fa-solid fa-play text-[9px]"></i>',
                    PAUSE: '<i class="fa-solid fa-pause text-[9px] text-brand-500"></i>',
                    MUTE: '<i class="fa-solid fa-volume-xmark text-[9px] text-red-500"></i>',
                    VOL: '<i class="fa-solid fa-volume-high text-[9px]"></i>'
                },
                RESOLVER_BASE: 'https://www.whatsmydns.net/url-unshortener?q=',
                // UPDATED: S1A now defaults to NATIVE instead of ANY_CLAPPR
                ENGINES: { S1A: 'NATIVE', S2: 'NATIVE' },
                SOURCES: { S1: 'S1', S1A: 'S1a', S2: 'S2', S2A: 'S2a' },
                ANY_PLAYER_URL: 'https://anym3u8player.com/ultimate-player-generator/player.php',
                RESOURCES: {
                    'HLS.JS': ['https://cdn.jsdelivr.net/npm/hls.js@latest'],
                    'VIDEOJS': ['https://vjs.zencdn.net/8.10.0/video-js.css', 'https://vjs.zencdn.net/8.10.0/video.min.js'],
                    'PLYR': ['https://cdn.plyr.io/3.7.8/plyr.css', 'https://cdn.plyr.io/3.7.8/plyr.js', 'https://cdn.jsdelivr.net/npm/hls.js@latest'],
                    'CLAPPR': ['https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js'],
                    'ARTPLAYER': ['https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js', 'https://cdn.jsdelivr.net/npm/hls.js@latest'],
                    'SHAKA': ['https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css', 'https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js'],
                    'DPLAYER': ['https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.js', 'https://cdn.jsdelivr.net/npm/hls.js@latest']
                },
                LOADED_RESOURCES: new Set()
            };

            const HELPERS = {
                getInitials: (name) => (name||"").match(/\b\w/g)?.slice(0,3).join('').toUpperCase() || (name||"").substring(0,3).toUpperCase(),
                getLogoHtml: (logos, name) => {
                    const ini = HELPERS.getInitials(name);
                    return logos?.[0] ? `<img src="${logos[0]}" loading="lazy" class="w-full h-full object-contain" onerror="window.handleLogoError(this, '${ini}')">` : `<span class="text-xs font-bold">${ini}</span>`;
                },
                loadDependency: (urls) => {
                    if (!urls) return Promise.resolve();
                    return Promise.all(urls.map(url => {
                        if (CONFIG.LOADED_RESOURCES.has(url)) return Promise.resolve();
                        return new Promise((resolve, reject) => {
                            let el;
                            if (url.endsWith('.css')) {
                                el = document.createElement('link'); el.rel = 'stylesheet'; el.href = url;
                            } else {
                                el = document.createElement('script'); el.src = url; el.async = true; el.crossOrigin = "anonymous";
                            }
                            el.onload = () => { CONFIG.LOADED_RESOURCES.add(url); resolve(); };
                            el.onerror = () => { vlog(`<span class="text-red-400">Failed dep: ${url}</span>`); reject(); };
                            document.head.appendChild(el);
                        });
                    }));
                },
                checkRAM: () => {
                    if ('deviceMemory' in navigator) {
                        const ram = navigator.deviceMemory;
                        vlog(`Hardware Detected: ~${ram}GB RAM`);
                        if (ram < 3) {
                            vlog("Performance Optimization: Shadows disabled.");
                            const style = document.createElement('style');
                            style.innerHTML = `* { box-shadow: none !important; -webkit-box-shadow: none !important; }`;
                            document.head.appendChild(style);
                        }
                    }
                }
            };

            const fetchResilient = async (url, lbl, isJson=true) => {
                if(!url) return null;
                vlog(`Fetching ${lbl}: ${url.substring(0,30)}...`);
                const enc = encodeURIComponent(url + (url.includes('?')?'&':'?') + 't=' + Date.now());
                const proxies = [["corsproxy.io", `https://corsproxy.io/?url=${enc}`], ["allorigins", `https://api.allorigins.win/get?url=${enc}`]];
                for (const [name, pUrl] of proxies) {
                    try {
                        const res = await fetch(pUrl); if (!res.ok) continue;
                        let d = name === "allorigins" ? (await res.json()).contents : await res.text();
                        if (isJson && typeof d === 'string') d = JSON.parse(d);
                        if(d) { vlog(`Success: ${lbl}`); return d; }
                    } catch (e) {}
                }
                vlog(`<span class="text-red-400">Failed to fetch ${lbl}</span>`);
                if(lbl === 'Metadata') window.toggleStats();
                return null;
            };

            const resolvedCache = new Map();
            let channelsMap = new Map(), meta = new Map(), baseCats = new Set();
            let filter = 'All', searchTerm = '', scheduleLoaded = false, currentStreamUrl = "";
            let manualMute = false, ccActive = localStorage.getItem(CC_PREF_KEY) === 'true', hasCaptions = false, controlsActive = false;
            let currentEngine = localStorage.getItem(ENGINE_PREF_KEY) || 'AUTO', currentPlayer = null, hlsInstance = null, statsInterval = null;
            
            let userPreferredSource = null;

            const urlParams = new URLSearchParams(window.location.search);
            const s1Format = urlParams.get('s1_format') || API_FALLBACKS.s1_format;
            const s2Format = urlParams.get('s2_format') || API_FALLBACKS.s2_format;
            const metaUrl = urlParams.get('metadata_url') || API_FALLBACKS.metadata_url;
            const scheduleUrl = urlParams.get('schedule_url') || API_FALLBACKS.schedule_url;
            const proxyUrl = urlParams.get('proxy_url') || API_FALLBACKS.proxy_url;

            let loadStartTime = 0, currentActiveSid = null, recoveryAttempts = 0; 

            const setStatus = (txt) => { const el = s('lastEvent'); if (el) el.innerText = txt ? txt.toUpperCase() : "IDLE"; };
            const vlog = (msg) => {
                const log = s('bootLog'); if(!log) return;
                const entry = document.createElement('div'); entry.className = "border-b border-white/5 py-0.5 break-all";
                entry.innerHTML = `<span class="opacity-40">[${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'})}]</span> ${msg}`;
                log.prepend(entry);
            };
            const rlog = (msg) => { const log = s('resolutionLog'); if(!log) return; const entry = document.createElement('div'); entry.className = "border-b border-white/5 py-0.5 break-all"; entry.innerHTML = `> ${msg}`; log.prepend(entry); };

            const getS1Url = (slug) => s1Format ? s1Format.replace('{slug}', slug) : "";
            const getS2Url = (slug) => s2Format ? s2Format.replace('{slug}', slug) : "";
            const loaderHTML = `<div id="vLoader" class="absolute inset-0 flex items-center justify-center bg-black z-50 text-white font-bold tracking-widest pointer-events-none"><div class="flex flex-col items-center gap-2"><i class="fa-solid fa-circle-notch fa-spin text-2xl text-brand-500"></i><span class="text-xs opacity-70">LOADING...</span></div></div>`;

            const isHostedEngine = (eng) => eng === 'STAND_ALONE' || eng === 'DEBUG' || eng.startsWith('ANY_');

            const setupHlsLogging = (h) => {
                if (!h) return;
                h.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                vlog("HLS Network Error, retrying...");
                                h.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                vlog("HLS Media Error, recovering...");
                                h.recoverMediaError();
                                break;
                            default:
                                vlog("HLS Fatal Error, restarting...");
                                h.destroy();
                                loadStream(currentStreamUrl);
                                break;
                        }
                    }
                });
            };

            window.toggleStats = () => {
                const overlay = s('statsOverlay'), panel = s('logPanel'), btn = s('logToggle');
                if (!overlay || !panel) return;
                const isHidden = panel.classList.contains('hidden');
                panel.classList.toggle('hidden'); overlay.classList.toggle('hidden');
                if (btn) { btn.classList.toggle('bg-brand-600', isHidden); btn.classList.toggle('text-white', isHidden); }
                if(!overlay.classList.contains('hidden')) {
                    if(statsInterval) clearInterval(statsInterval);
                    statsInterval = setInterval(updateStats, 1000); vlog("Verbose debugger enabled");
                } else { clearInterval(statsInterval); }
            };

            const updateStats = () => {
                const content = s('statsContent'); if(!content) return;
                let html = `ENG: ${currentEngine}<br>URL: ${currentStreamUrl ? currentStreamUrl.split('/').pop().split('?')[0] : 'NONE'}<br>`;
                if(currentPlayer) {
                    const v = currentPlayer.tagName === 'VIDEO' ? currentPlayer : (currentPlayer.video || document.querySelector('video'));
                    if(v) {
                        html += `RES: ${v.videoWidth}x${v.videoHeight}<br>VOL: ${Math.round(v.volume * 100)}% ${v.muted ? '(MUTED)' : ''}<br>`;
                        html += `BUF: ${v.buffered.length ? (v.buffered.end(0) - v.currentTime).toFixed(2) + 's' : '0s'}<br>`;
                    }
                }
                if(currentEngine === 'HLS.JS' && hlsInstance) { html += `BIT: ${(hlsInstance.levels[hlsInstance.currentLevel]?.bitrate / 1000000).toFixed(2)} Mbps<br>`; }
                content.innerHTML = html;
            };

            const getProgramInfo = (chan, now) => {
                const ps = (chan.next_programs || []).filter(p => now <= (new Date(p['data-listdatetime']).getTime() + (p['data-duration'] * 60000)));
                if (!scheduleLoaded) return { current: "Loading...", next: "", isOffAir: false, isMovie: false };
                if (!ps.length) return { current: "Sign Off", next: "", isOffAir: true, isMovie: false };
                const showRaw = ps[0]['data-showname'] || "";
                const epRaw = ps[0]['data-episodetitle'] || "";
                const isMov = showRaw.toLowerCase().includes('movie');
                const format = (p) => {
                    const sName = p['data-showname'] || "";
                    const eName = p['data-episodetitle'] || "";
                    if (sName.toLowerCase() === 'movie') return eName || 'Movie';
                    return eName ? `${sName}: ${eName}` : sName;
                };
                return { current: format(ps[0]), next: ps[1] ? `${new Date(ps[1]['data-listdatetime']).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} - ${format(ps[1])}` : "", isOffAir: false, isMovie: isMov, rawShow: showRaw, rawEp: epRaw, desc: ps[0]['data-description'] || "No description.", progress: Math.min(100, Math.max(0, ((now - new Date(ps[0]['data-listdatetime']).getTime()) / (ps[0]['data-duration'] * 60000)) * 100)) };
            };

            const players = {
                'IFRAME': async (url, w, variant, logo='') => {
                    const engine = variant.startsWith('ANY_') ? variant.split('_')[1].toLowerCase() : 'clappr';
                    const encodedUrl = encodeURIComponent(url), encodedLogo = encodeURIComponent(logo);
                    let frameUrl = "";
                    if (variant === 'DEBUG') { frameUrl = `https://galeksandrp.github.io/hls.js/demo/?src=${encodedUrl}&enableStreaming=true&autoRecoverError=true`; }
                    else if (variant === 'STAND_ALONE') { 
                        frameUrl = `${proxyUrl}?url=${encodedUrl}&player=clappr&autoplay=1&loop=1&controls=hidden&width=responsive`; 
                    }
                    else { 
                        frameUrl = `${proxyUrl}?url=${encodedUrl}&player=${engine}&autoplay=1&loop=1&controls=hidden&theme=flat&logo=1&poster=${encodedLogo}&width=responsive`; 
                    }
                    const handleFrameLoad = () => { 
                        if(s('vLoader')) s('vLoader').style.display='none'; 
                        setStatus('playing'); 
                        if (loadStartTime > 0) {
                            const diff = ((Date.now() - loadStartTime) / 1000).toFixed(2);
                            s('loadTimeDisplay').innerText = `Linked in ${diff}s`;
                            loadStartTime = 0;
                        }
                    };
                    w.innerHTML = loaderHTML + `<iframe id="extPlayerFrame" src="${frameUrl}" width="100%" height="100%" frameborder="0" allow="autoplay; fullscreen"></iframe>`;
                    s('extPlayerFrame').onload = handleFrameLoad; return { type: 'iframe' };
                },
                'NATIVE': async (url, w) => { 
                    await HELPERS.loadDependency(CONFIG.RESOURCES['HLS.JS']);
                    w.innerHTML = loaderHTML + `<video id="videoPlayer" autoplay ${controlsActive?'controls':''} style="width:100%;height:100%;background:#000"></video>`; 
                    const v = s('videoPlayer'); v.muted = manualMute;
                    if(Hls.isSupported()) { 
                        hlsInstance = new Hls(); setupHlsLogging(hlsInstance); hlsInstance.loadSource(url); hlsInstance.attachMedia(v); 
                        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => v.play().catch(()=>{}));
                    } else { v.src = url; v.play().catch(()=>{}); }
                    setupNativeEvents(v, 'NATIVE'); return v; 
                },
                'HLS.JS': async (url, w) => { 
                    await HELPERS.loadDependency(CONFIG.RESOURCES['HLS.JS']);
                    w.innerHTML = loaderHTML + `<video id="videoPlayer" autoplay ${controlsActive?'controls':''} style="width:100%;height:100%;background:#000"></video>`; 
                    const v = s('videoPlayer'); v.muted = manualMute; 
                    if(Hls.isSupported()) { 
                        hlsInstance = new Hls(); setupHlsLogging(hlsInstance); hlsInstance.loadSource(url); hlsInstance.attachMedia(v); 
                        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => v.play().catch(()=>{}));
                    } else { v.src = url; v.play().catch(()=>{}); }
                    setupNativeEvents(v, 'HLS.JS'); return v; 
                },
                'VIDEOJS': async (url, w) => { 
                    await HELPERS.loadDependency(CONFIG.RESOURCES['VIDEOJS']);
                    w.innerHTML = loaderHTML + `<video id="videoPlayer" autoplay style="width:100%;height:100%;background:#000"></video>`; 
                    const v = s('videoPlayer'); v.muted = manualMute; 
                    if(Hls.isSupported()) { hlsInstance = new Hls(); hlsInstance.loadSource(url); hlsInstance.attachMedia(v); } else { v.src = url; }
                    setupNativeEvents(v, 'VIDEOJS'); return v; 
                },
                'PLYR': async (url, w) => { 
                    await HELPERS.loadDependency(CONFIG.RESOURCES['PLYR']);
                    w.innerHTML = loaderHTML + `<video id="plyr_player" crossorigin playsinline style="width:100%;height:100%"></video>`; 
                    const v = s('plyr_player'); setupNativeEvents(v, 'PLYR'); 
                    if(Hls.isSupported()) { hlsInstance = new Hls(); setupHlsLogging(hlsInstance); hlsInstance.loadSource(url); hlsInstance.attachMedia(v); } else v.src = url; 
                    return new Plyr(v, { autoplay: true, muted: manualMute, controls: controlsActive ? ['play-large','play','progress','current-time','mute','volume','captions','settings','pip','airplay','fullscreen'] : [] }); 
                },
                'CLAPPR': async (url, w) => { 
                    await HELPERS.loadDependency(CONFIG.RESOURCES['CLAPPR']);
                    w.innerHTML = loaderHTML + `<div id="clapprContainer"></div>`; 
                    const p = new Clappr.Player({ source: url, parentId: "#clapprContainer", width: '100%', height: '100%', autoPlay: true, mute: manualMute, chromeless: !controlsActive }); 
                    p.on(Clappr.Events.PLAYER_PLAY, ()=>{ if(s('vLoader')) s('vLoader').style.display='none'; setStatus('playing'); updatePlayButton(); }); return p; 
                },
                'ARTPLAYER': async (url, w) => { 
                    await HELPERS.loadDependency(CONFIG.RESOURCES['ARTPLAYER']);
                    w.innerHTML = loaderHTML + `<div id="artContainer"></div>`; 
                    const p = new Artplayer({ container: '#artContainer', url: url, type: 'm3u8', autoplay: true, muted: manualMute, isLive: true, customType: { m3u8: (v, u) => { if(Hls.isSupported()){ hlsInstance=new Hls(); setupHlsLogging(hlsInstance); hlsInstance.loadSource(u); hlsInstance.attachMedia(v); } else v.src=u; } } }); 
                    if(p.video) setupNativeEvents(p.video, 'ARTPLAYER'); return p; 
                },
                'SHAKA': async (url, w) => { 
                    await HELPERS.loadDependency(CONFIG.RESOURCES['SHAKA']);
                    w.innerHTML = loaderHTML + `<div id="shakaContainer"><video id="shakaVideo" style="width:100%;height:100%;background:#000" autoplay></video></div>`; 
                    shaka.polyfill.installAll(); const v = s('shakaVideo'); setupNativeEvents(v, 'SHAKA'); 
                    const p = new shaka.Player(v), ui = new shaka.ui.Overlay(p, s('shakaContainer'), v); v.muted = manualMute; 
                    p.load(url).then(()=>{ v.play().catch(()=>{}); }); return { player: p, ui: ui, video: v }; 
                },
                'DPLAYER': async (url, w) => { 
                    await HELPERS.loadDependency(CONFIG.RESOURCES['DPLAYER']);
                    w.innerHTML = loaderHTML + `<div id="dplayerContainer"></div>`; 
                    const p = new DPlayer({ container: s('dplayerContainer'), autoplay: true, video: { url: url, type: 'hls' }, volume: manualMute?0:0.7 }); 
                    if(p.video) setupNativeEvents(p.video, 'DPLAYER'); return p; 
                }
            };

            async function play(u, eng, name, title, dTitle, extra = {}) {
                if(eng && eng !== 'AUTO') setEngine(eng);
                s('playerContainer').classList.remove('hidden');
                const body=s('pd-desc'), logoEl=s('playingLogo');
                body.innerText = ""; s('loadTimeDisplay').innerText = "Linking..."; setStatus('loading'); recoveryAttempts = 0;
                
                if(extra.sid && meta.has(extra.sid)) {
                    const m = meta.get(extra.sid); logoEl.classList.remove('hidden'); logoEl.innerHTML = HELPERS.getLogoHtml(m.logos, name);
                } else { logoEl.classList.add('hidden'); }

                if(extra.sid && channelsMap.has(extra.sid)) {
                    const c = channelsMap.get(extra.sid); const prog = getProgramInfo(c, Date.now());
                    if(prog.current && prog.current !== "Sign Off") {
                        const showName = prog.rawShow || "";
                        if(showName.toLowerCase() === 'movie') s('playingTitle').innerText = prog.rawEp || prog.current || name;
                        else s('playingTitle').innerHTML = prog.rawEp ? `${showName} <span class="text-[11px] text-slate-400 font-normal ml-1.5 tracking-normal">${prog.rawEp}</span>` : showName || prog.current || name;
                        body.innerText = prog.desc; 
                    } else { s('playingTitle').innerText = name; }
                } else { s('playingTitle').innerText = name; }
                
                if(!u && extra.resolver) {
                    const ru = await resolveUrl(extra.slug, extra.label);
                    if(ru) await loadStream(ru, ""); else { setStatus('error'); s('loadTimeDisplay').innerText = "Resolution Error"; }
                } else if(u) { await loadStream(u, ""); }
            }
            
            window.play = play;
            window.changeEngine = (val) => { 
                if (val === 'AUTO') {
                    localStorage.removeItem(ENGINE_PREF_KEY);
                    userPreferredSource = null;
                    currentEngine = 'AUTO';
                    vlog("Engine preference reset to AUTO");
                    if(currentActiveSid) { 
                        const sid = currentActiveSid; currentActiveSid = null;
                        document.querySelector(`[data-sid="${sid}"]`)?.click();
                    }
                } else {
                    currentEngine = val;
                    localStorage.setItem(ENGINE_PREF_KEY, val);
                    updateControlVisibility(val); 
                    if(currentStreamUrl) loadStream(currentStreamUrl); 
                }
            };

            const setEngine = (e) => { 
                currentEngine = e; 
                s('playerEngineSelect').value = e; 
                updateControlVisibility(e); 
            };

            const updateControlVisibility = (eng) => { const hosted = isHostedEngine(eng); s('mainControls').classList.toggle('hidden', hosted); s('hostedControls').classList.toggle('hidden', !hosted); };
            
            const destroyActivePlayer = () => {
                if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
                if (currentPlayer) { try { if (currentPlayer.ui?.destroy) { currentPlayer.ui.destroy(); currentPlayer.player.destroy(); } else if (currentPlayer.dispose) currentPlayer.dispose(); else if (currentPlayer.destroy) currentPlayer.destroy(); } catch(e) {} }
                currentPlayer = null; s('videoWrapper').innerHTML = '';
            };

            const setupNativeEvents = (v, eng) => {
                if(!v) return;
                ['play','playing','pause','volumechange','error'].forEach(e => { v.addEventListener(e, () => { 
                    setStatus(e); 
                    if(e==='playing'||e==='loadeddata') { 
                        if(s('vLoader')) s('vLoader').style.display='none'; 
                        if (loadStartTime > 0) {
                            const diff = ((Date.now() - loadStartTime) / 1000).toFixed(2);
                            s('loadTimeDisplay').innerText = `Linked in ${diff}s`;
                            loadStartTime = 0;
                        }
                    } 
                    if(['play','playing','pause'].includes(e)) updatePlayButton(v); 
                }); });
            };

            const loadStream = async (url, logoUrl='') => { 
                destroyActivePlayer(); currentStreamUrl = url; hasCaptions = false; 
                loadStartTime = Date.now();
                s('loadTimeDisplay').innerText = ""; 
                const eng = currentEngine === 'AUTO' ? 'NATIVE' : currentEngine; 
                vlog(`Loading: ${eng} -> ${url}`);
                if(isHostedEngine(eng)) currentPlayer = await players.IFRAME(url, s('videoWrapper'), eng, logoUrl); 
                else if(players[eng]) currentPlayer = await players[eng](url, s('videoWrapper')); 
            };

            window.toggleFullscreen = () => { const e=s('videoWrapper'); if(!e)return; if (document.fullscreenElement) document.exitFullscreen(); else e.requestFullscreen().catch(()=>{}); };
            window.togglePlay = () => { if(!currentPlayer) return; try { const v = currentPlayer.tagName === 'VIDEO' ? currentPlayer : (currentPlayer.video || document.querySelector('video')); if(v) v.paused?v.play():v.pause(); } catch(e){} };
            window.toggleMute = () => { manualMute = !manualMute; document.querySelectorAll('.mute-toggle-btn').forEach(i => i.innerHTML = manualMute ? CONFIG.ICON.MUTE : CONFIG.ICON.VOL); try { const v = currentPlayer.tagName === 'VIDEO' ? currentPlayer : (currentPlayer.video || document.querySelector('video')); if(v) v.muted = manualMute; } catch(e){} };
            window.toggleCC = () => { if(!hasCaptions) return; ccActive=!ccActive; localStorage.setItem(CC_PREF_KEY, ccActive); applyCCState(); updateCCUI(); };
            window.toggleControls = () => { 
                controlsActive = !controlsActive; s('controlsToggle').classList.toggle('bg-brand-600', controlsActive); s('controlsToggle').classList.toggle('text-white', controlsActive);
                if(!currentPlayer) return;
                try {
                    if (currentEngine === 'VIDEOJS' && currentPlayer.controls) currentPlayer.controls(controlsActive);
                    else if (currentEngine === 'PLYR' || currentEngine === 'CLAPPR' || isHostedEngine(currentEngine)) { loadStream(currentStreamUrl); }
                    else {
                        const v = currentPlayer.tagName === 'VIDEO' ? currentPlayer : (currentPlayer.video || document.querySelector('video'));
                        if(v) v.controls = controlsActive;
                    }
                } catch(e){}
            };
            const updateCCUI = () => { document.querySelectorAll('.cc-toggle-btn').forEach(b => { b.style.opacity = hasCaptions ? 1 : 0.5; b.style.cursor = hasCaptions ? 'pointer' : 'not-allowed'; b.classList.toggle('text-brand-500', hasCaptions && ccActive); }); };
            const applyCCState = () => { if(!hasCaptions) return; if(currentEngine==='HLS.JS'&&hlsInstance) hlsInstance.subtitleTrack=ccActive?0:-1; let v=s('videoPlayer')||currentPlayer?.video; if(v?.textTracks) Array.from(v.textTracks).forEach(t=>t.mode=ccActive?'showing':'hidden'); };
            const updatePlayButton = (v) => { const html = (v?v.paused:true) ? CONFIG.ICON.PLAY : CONFIG.ICON.PAUSE; document.querySelectorAll('.play-toggle-btn').forEach(b => b.innerHTML = html); };
            window.unmutePlayer = () => { manualMute=false; window.toggleMute(); s('unmutePrompt').style.display='none'; };
            window.reloadCurrent = () => { currentStreamUrl && loadStream(currentStreamUrl); };
            window.closePlayer = () => { setStatus('idle'); destroyActivePlayer(); s('playerContainer').classList.add('hidden'); currentActiveSid = null; draw(); };
            window.openCurrentTab = () => {
                if(!currentStreamUrl) return; const u=encodeURIComponent(currentStreamUrl); 
                if(isHostedEngine(currentEngine)) { 
                    const eng = currentEngine.startsWith('ANY_') ? currentEngine.split('_')[1].toLowerCase() : 'clappr'; 
                    window.open(`${CONFIG.ANY_PLAYER_URL}?url=${u}&player=${eng}&autoplay=1&muted=${manualMute?1:0}&controls=${controlsActive?'always':'hidden'}&width=responsive`,'_blank'); 
                } 
                else window.open(currentStreamUrl,'_blank'); 
            };
            const renderSourceButtons = (sid, n, prog) => {
                const c = s('sourceSelect'), m = meta.get(sid); if(!c || !m) return;
                const esc = (s) => (s||"").replace(/'/g, "\\'"); c.dataset.sid = esc(sid); c.dataset.name = esc(n); c.dataset.prog = esc(prog);
                let h = "";
                if(m.slug1) h += `<option value="${CONFIG.SOURCES.S1}">${CONFIG.SOURCES.S1}</option><option value="${CONFIG.SOURCES.S1A}">${CONFIG.SOURCES.S1A}</option>`;
                if(m.slug2) h += `<option value="${CONFIG.SOURCES.S2}">${CONFIG.SOURCES.S2}</option><option value="${CONFIG.SOURCES.S2A}">${CONFIG.SOURCES.S2A}</option>`;
                c.innerHTML = h; c.classList.toggle('hidden', !h);
                if (userPreferredSource) c.value = userPreferredSource;
            };
            window.handleSourceChange = (val) => {
                userPreferredSource = val;
                const c = s('sourceSelect'), m = meta.get(c.dataset.sid);
                if (val === CONFIG.SOURCES.S1) window.playDirectS1(m.slug1, c.dataset.name, c.dataset.prog, c.dataset.sid);
                else if (val === CONFIG.SOURCES.S1A) window.playResolver(m.slug1, CONFIG.SOURCES.S1A, c.dataset.name, c.dataset.prog, c.dataset.sid);
                else if (val === CONFIG.SOURCES.S2) window.playDirectS2(m.slug2, c.dataset.name, c.dataset.prog, c.dataset.sid);
                else if (val === CONFIG.SOURCES.S2A) window.playResolver(m.slug2, CONFIG.SOURCES.S2A, c.dataset.name, c.dataset.prog, c.dataset.sid);
            };
            window.setActiveSource = (lbl) => { const sel = s('sourceSelect'); if (sel) sel.value = lbl; };
            window.playDirectS1 = (s,n,t,id) => { window.setActiveSource(CONFIG.SOURCES.S1); play(getS1Url(s), currentEngine === 'AUTO' ? 'STAND_ALONE' : currentEngine, n, t, CONFIG.SOURCES.S1, {sid:id}); };
            window.playDirectS2 = (s,n,t,id) => { window.setActiveSource(CONFIG.SOURCES.S2); play(getS2Url(s), currentEngine === 'AUTO' ? 'NATIVE' : currentEngine, n, t, CONFIG.SOURCES.S2, {sid:id}); };
            window.playResolver = (s,l,n,t,id) => { window.setActiveSource(l); play(null, currentEngine === 'AUTO' ? (l === CONFIG.SOURCES.S1A ? CONFIG.ENGINES.S1A : CONFIG.ENGINES.S2) : currentEngine, n, t, l, {sid:id, resolver:true, slug:s, label:l}); };
            
            window.playAuto = async (sid, n, t) => {
                if (currentActiveSid === sid) { window.toggleFullscreen(); return; }
                const m=meta.get(sid); if(!m) return;
                currentActiveSid = sid;
                document.querySelectorAll('.channel-card-active').forEach(el => { el.className = el.className.replace(CONFIG.CLASS.ACTIVE, CONFIG.CLASS.RESET); });
                const newEl = document.querySelector(`[data-sid="${sid}"]`);
                if (newEl) { newEl.className = newEl.className.replace(CONFIG.CLASS.RESET, CONFIG.CLASS.ACTIVE); newEl.focus(); }
                renderSourceButtons(sid, n, t); 
                
                await play(null, null, n, t, 'AUTO', {sid:sid});

                if (userPreferredSource && ((userPreferredSource.startsWith('S1') && m.slug1) || (userPreferredSource.startsWith('S2') && m.slug2))) {
                    window.handleSourceChange(userPreferredSource);
                    return;
                }

                if(m.slug1) {
                    const u=await resolveUrl(m.slug1, CONFIG.SOURCES.S1A);
                    if(u) { await loadStream(u, ""); window.setActiveSource(CONFIG.SOURCES.S1A); setEngine(CONFIG.ENGINES.S1A); return; }
                }
                if(m.slug2) { await loadStream(getS2Url(m.slug2), ""); window.setActiveSource(CONFIG.SOURCES.S2); setEngine(CONFIG.ENGINES.S2); }
            };

            window.onSearch = (v) => { searchTerm=v.toLowerCase().trim(); draw(); };
            window.handleLogoError = (i, t) => { const p=i.parentElement; p.classList.add('bg-slate-700'); p.innerHTML=`<span class="text-xs font-bold">${t}</span>`; };
            window.scrollList = (d) => window.scrollBy({top:window.innerHeight*0.7*d, behavior:'smooth'});
            const resolveUrl = async (slug, label) => {
                const key = `${label}:${slug}`; if (resolvedCache.has(key)) return resolvedCache.get(key);
                const b = label.startsWith('S1') ? getS1Url(slug) : getS2Url(slug);
                if(!b) return null;
                const r = await fetchResilient(CONFIG.RESOLVER_BASE + encodeURIComponent(b), "unshortener", false);
                if(r) {
                    const doc = new DOMParser().parseFromString(r, 'text/html'), l = doc.querySelector('a[href*="token="], a[href*=".m3u8"]');
                    if(l?.href) { let f = l.href; if(label === CONFIG.SOURCES.S2A) { const u = new URL(f), p = u.hostname.split('.'); if(p.length >= 2) { p[0] = 'e2'; u.hostname = p.join('.'); f = u.toString(); } } resolvedCache.set(key, f); return f; }
                }
                resolvedCache.set(key, null); return null;
            };

            window.sf = (v) => { filter=v; draw(); window.scrollTo({top:0,behavior:'smooth'}); };

            const draw = () => {
                const now=Date.now(), html=[], focusedSid = document.activeElement ? document.activeElement.getAttribute('data-sid') : null;
                for(const [sid, c] of channelsMap) {
                    const m=meta.get(sid)||{}, prog=getProgramInfo(c, now), name=(m.name||c.title||sid);
                    
                    const isMovieCat = m.category && m.category.toLowerCase().includes('movie');
                    const isMovieShow = prog.isMovie;
                    
                    if(filter!=='All') {
                        if (filter === 'Off-Air') { if (!prog.current || prog.current === "Sign Off") {} else continue; }
                        else if (filter === 'Movies') { if (!isMovieCat && !isMovieShow) continue; }
                        else if (m.category !== filter) continue;
                    }

                    if(searchTerm && !name.toLowerCase().includes(searchTerm) && !prog.current.toLowerCase().includes(searchTerm)) continue;
                    
                    const activeClass = sid === currentActiveSid ? CONFIG.CLASS.ACTIVE : CONFIG.CLASS.RESET;
                    const logoHtml = HELPERS.getLogoHtml(m.logos, name);
                    
                    let displayHtml = prog.current; 
                    if (!prog.isMovie && prog.rawEp && prog.rawShow) {
                        displayHtml = `${prog.rawShow} <span class="text-xs text-slate-400 font-normal ml-1 opacity-90">${prog.rawEp}</span>`;
                    }

                    html.push(`<div data-sid="${sid}" tabindex="0" onclick="window.playAuto('${sid}','${name.replace(/'/g,"\\'")}','${prog.current.replace(/'/g,"\\'")}')" class="nav-item group relative flex flex-col items-start gap-3 px-3 py-2 ${activeClass} hover:bg-slate-800 border border-slate-800/50 rounded-xl cursor-pointer focus:outline-none focus:bg-slate-800 transition-all duration-200"> <div class="flex items-center gap-3 w-full"> <div class="flex-shrink-0 w-14 h-10 bg-slate-900 rounded-lg flex items-center justify-center p-1 border border-slate-800 overflow-hidden">${logoHtml}</div> <div class="flex-grow min-w-0 epg-text-box"> <div class="flex items-center gap-2 mb-0.5"><h3 class="font-bold text-white text-sm md:text-base leading-tight truncate">${displayHtml}</h3>${(m.color==='red'||m.color==='orange')?`<span class="inline-block w-2 h-2 rounded-full ${m.color==='red'?'bg-red-500 live-dot':'bg-orange-400'} ml-2"></span>`:''}</div> ${prog.next ? `<p class="text-xs text-slate-500 mt-0.5 flex items-center gap-1 truncate"><i class="fa-regular fa-clock"></i> ${prog.next}</p>` : ''} </div> </div> ${prog.progress > 0 ? `<div class="w-full h-0.5 bg-white/5 mt-2 rounded-full overflow-hidden"><div class="h-full bg-brand-500" style="width:${prog.progress}%"></div></div>` : ''} </div>`);
                }
                const sorted = [...baseCats].sort((a,b)=>(a==='All'?-1:b==='All'?1:a.localeCompare(b)));
                s('filterMenu').innerHTML = sorted.map(c => `<button onclick="sf('${c}')" class="nav-item whitespace-nowrap px-3 py-1 rounded-full text-xs font-bold transition-colors ${filter===c ? 'bg-brand-600 text-white shadow' : 'bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white'}">${c}</button>`).join('');
                s('list').innerHTML = html.join('') || `<div class="col-span-full h-32 flex items-center justify-center text-slate-600 text-sm italic text-center">No channels found.</div>`;
                if (focusedSid) { requestAnimationFrame(() => document.querySelector(`[data-sid="${focusedSid}"]`)?.focus()); }
            };

            window.initFocus = () => { const firstCat = document.querySelector('#filterMenu .nav-item'); if (firstCat) firstCat.focus(); };

            document.addEventListener('keydown', (e) => {
                const k = e.key; 
                if (k === 'Enter') { e.preventDefault(); if (document.fullscreenElement) { document.exitFullscreen(); return; } const active = document.activeElement; if (active && (active.classList.contains('nav-item') || active.tagName === 'BUTTON')) { active.click(); return; } return; }
                if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(k)) return;
                const active = document.activeElement;
                const items = Array.from(document.querySelectorAll('.nav-item, input#searchInput, #playerContainer select, #playerContainer button')).filter(el => {
                    const r = el.getBoundingClientRect();
                    return r.width > 0 && r.height > 0 && getComputedStyle(el).visibility !== 'hidden' && getComputedStyle(el).display !== 'none';
                });
                if (items.length === 0) return; 
                if (!items.includes(active)) { e.preventDefault(); (document.querySelector('.channel-card-active') || items[0]).focus(); return; }
                e.preventDefault(); 
                const cur = active.getBoundingClientRect();
                const curCenter = { x: cur.left + cur.width/2, y: cur.top + cur.height/2 };
                let best = null, bestScore = Infinity;
                items.forEach(el => {
                    if (el === active) return; 
                    const rect = el.getBoundingClientRect();
                    const center = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
                    let isValid = false; 
                    const threshold = 15; 
                    if (k === 'ArrowUp') isValid = center.y < cur.top + threshold; 
                    else if (k === 'ArrowDown') isValid = center.y > cur.bottom - threshold; 
                    else if (k === 'ArrowLeft') isValid = center.x < cur.left + threshold; 
                    else if (k === 'ArrowRight') isValid = center.x > cur.right - threshold;
                    if (isValid) {
                        const dx = Math.abs(center.x - curCenter.x);
                        const dy = Math.abs(center.y - curCenter.y);
                        let score = (k === 'ArrowUp' || k === 'ArrowDown') ? dy + (dx * 3) : dx + (dy * 3);
                        if (score < bestScore) { bestScore = score; best = el; }
                    }
                });
                if (best) { 
                    best.focus(); 
                    best.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });

            // --- REFRESH LOGIC ---
            const syncEPG = async () => {
                if (!scheduleUrl) return;
                const sc = await fetchResilient(scheduleUrl, 'EPG Refresh');
                if (sc) { 
                    scheduleLoaded = true;
                    (Array.isArray(sc) ? sc : (sc.channels || [])).forEach(c => {
                        const id = (c.site_id || "").trim().toLowerCase();
                        if (channelsMap.has(id)) channelsMap.get(id).next_programs = c.next_programs;
                        else channelsMap.set(id, c);
                    });
                    draw();
                }
            };

            try {
                HELPERS.checkRAM();
                vlog("Init...");
                const activeKey = metaUrl ? `epg_${btoa(metaUrl).substring(0,12)}` : CACHE_KEY;
                let md = null, cObj = localStorage.getItem(activeKey);
                if(cObj) { const p=JSON.parse(cObj); if(Date.now()-p.ts<CACHE_TTL) md=p.data; }
                if(!md && metaUrl) { md=await fetchResilient(metaUrl,'Metadata'); if(md) localStorage.setItem(activeKey, JSON.stringify({ts:Date.now(),data:md})); }
                if(md) { 
                    (Array.isArray(md)?md:(md.channels||md.data||[])).forEach(i => { const id=(i.mapping?.tvg_id||i.id||"").trim().toLowerCase(); if(id) { meta.set(id, {name:i.display_name, category:i.group_title, logos:i.logos, slug1:i.mapping?.slug1||i.slug, slug2:i.mapping?.slug2||i.slug2, color:(i.info||i.color||"").toString().toLowerCase()}); channelsMap.set(id, {site_id:id, title:i.display_name, next_programs:[]}); if(i.group_title) baseCats.add(i.group_title); } }); 
                    baseCats.add('All'); baseCats.add('Movies'); baseCats.add('Off-Air');
                    draw(); window.initFocus(); 
                }
                await syncEPG();
                setInterval(draw, 60000);     // Every minute UI refresh
                setInterval(syncEPG, 300000); // Every 5 minutes network refresh
                vlog("System Ready.");
            } catch(e) { vlog("Boot Error: " + e.message); console.error(e); }
        })();
    </script>
</body>
</html>
