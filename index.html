<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 
        CSP FIX: 
        Ensures 'blob:' scheme is explicitly allowed for media and workers.
    -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; media-src * blob: data:; worker-src * blob:; child-src * blob:; connect-src *;">
    
    <title>Stream Player (mpegts.js)</title>
    <!-- Restored specific distribution URL -->
    <script src="https://xqq.im/mpegts.js/dist/mpegts.js"></script>
    
    <style>
        .mainContainer { max-width: 800px; margin: 0 auto; font-family: sans-serif; padding: 20px; }
        .centeredVideo { background: #000; width: 100%; height: auto; border: 1px solid #444; border-radius: 4px; }
        .url-input-container { margin-bottom: 20px; }
        .url-input-container input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        .logcatBox { width: 100%; font-family: monospace; font-size: 11px; background: #222; color: #0f0; border: 1px solid #000; padding: 10px; box-sizing: border-box; border-radius: 4px; margin-top: 20px; }
        #statusOverlay { color: #5cb85c; font-weight: bold; margin-bottom: 10px; font-size: 14px; }
        .warning-box { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 10px; margin-bottom: 15px; font-size: 13px; border-radius: 4px; display: none; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
    </style>
</head>
<body>
    <div class="mainContainer">
        <div id="statusOverlay">Status: Ready</div>
        
        <div id="cspWarning" class="warning-box">
            <strong>Security Alert:</strong> Your browser is blocking 'blob:' media. This is likely due to the parent site's (e.g. start.me) Content Security Policy. You may need to host this outside of an iframe.
        </div>

        <div class="url-input-container">
            <label for="sURL">Stream URL (Press Enter to Load):</label>
            <input id="sURL" type="text" value="https://stream-cdn-iad3.vaughnsoft.net/play/live_tbbtz.flv" placeholder="Enter .flv or .ts URL" />
        </div>

        <div class="video-container">
            <video name="videoElement" id="videoElement" class="centeredVideo" controls autoplay muted>
                Your browser doesn't support HTML5 video.
            </video>
        </div>

        <textarea name="logcatbox" class="logcatBox" rows="12" readonly placeholder="Engine logs will appear here..."></textarea>
    </div>

    <script>
        var player = null;

        function updateStatus(msg, isError = false) {
            const status = document.getElementById('statusOverlay');
            if (status) {
                status.innerText = "Status: " + msg;
                status.style.color = isError ? "#d9534f" : "#5cb85c";
            }
        }

        function ls_get(key, def) {
            try {
                var ret = localStorage.getItem('player_demo.' + key);
                return ret === null ? def : ret;
            } catch (e) { return def; }
        }

        function ls_set(key, value) {
            try { localStorage.setItem('player_demo.' + key, value); } catch (e) {}
        }

        function player_load() {
            if (typeof mpegts === 'undefined') {
                updateStatus("Engine library not loaded.", true);
                return;
            }

            var finalUrl = document.getElementById('sURL').value;
            if (!finalUrl) {
                updateStatus("Please enter a Stream URL", true);
                return;
            }

            document.getElementById('cspWarning').style.display = 'none';
            updateStatus("Loading...");

            var mediaDataSource = { 
                type: 'flv',
                url: finalUrl,
                isLive: true,
                withCredentials: false
            };

            var element = document.getElementById('videoElement');
            if (player != null) {
                player.unload();
                player.detachMediaElement();
                player.destroy();
                player = null;
            }

            try {
                player = mpegts.createPlayer(mediaDataSource, {
                    enableWorker: true,
                    lazyLoadMaxDuration: 3 * 60,
                    seekType: 'range',
                    liveBufferLatencyChasing: true
                });

                player.attachMediaElement(element);
                player.load();
                
                player.on(mpegts.Events.ERROR, function(type, details, data) {
                    updateStatus(`Error: ${type} (${details})`, true);
                    if (details === 'NetworkError') {
                        document.getElementById('cspWarning').style.display = 'block';
                    }
                });

                player.on(mpegts.Events.MEDIA_INFO, (info) => {
                    updateStatus("Playing");
                });

                if (mpegts.LoggingControl) {
                    mpegts.LoggingControl.addLogListener(function(type, str) {
                        var logbox = document.getElementsByName('logcatbox')[0];
                        if (logbox) {
                            logbox.value = logbox.value + str + '\n';
                            logbox.scrollTop = logbox.scrollHeight;
                        }
                    });
                }

                player.play().catch(e => {
                    updateStatus("Autoplay blocked. Please click play on video.", false);
                });

            } catch (e) {
                updateStatus("Engine initialization failed", true);
            }
        }

        function loadSettings() {
            var sURL = document.getElementById('sURL');
            if (sURL) {
                // Check URL parameters first
                const urlParams = new URLSearchParams(window.location.search);
                const queryUrl = urlParams.get('url');
                
                if (queryUrl) {
                    sURL.value = queryUrl;
                } else {
                    sURL.value = ls_get('sURL', sURL.value);
                }
            }
        }

        function saveSettings() {
            var sURL = document.getElementById('sURL');
            if (sURL) {
                ls_set('sURL', sURL.value);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            loadSettings();
            
            document.getElementById('sURL').onkeyup = function(event) {
                if (event.key === 'Enter') {
                    saveSettings();
                    player_load();
                }
            };

            // Auto-load the saved or default URL on start
            player_load();
        });
    </script>
</body>
</html>
