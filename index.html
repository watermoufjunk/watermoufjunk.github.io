<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 
        CSP FIX: 
        Ensures 'blob:' scheme is explicitly allowed for media and workers.
    -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; media-src * blob: data:; worker-src * blob:; child-src * blob:; connect-src *;">
    
    <title>Stream Player</title>
    <script src="https://xqq.im/mpegts.js/dist/mpegts.js"></script>
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .video-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #videoElement {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        /* Hidden UI elements for debugging if needed via Inspect Element */
        #statusOverlay, .url-input-container, .logcatBox, .warning-box {
            display: none !important;
        }
    </style>
</head>
<body>

    <div class="video-container">
        <video name="videoElement" id="videoElement" controls autoplay muted>
            Your browser doesn't support HTML5 video.
        </video>
    </div>

    <!-- Hidden elements kept for logic compatibility -->
    <div class="url-input-container">
        <input id="sURL" type="text" value="" />
    </div>
    <div id="statusOverlay"></div>
    <div id="cspWarning"></div>
    <textarea id="logcatbox"></textarea>

    <script>
        var player = null;

        function ls_get(key, def) {
            try {
                var ret = localStorage.getItem('player_demo.' + key);
                return ret === null ? def : ret;
            } catch (e) { return def; }
        }

        function player_load() {
            if (typeof mpegts === 'undefined') return;

            var finalUrl = document.getElementById('sURL').value;
            if (!finalUrl) return;

            var mediaDataSource = { 
                type: 'flv',
                url: finalUrl,
                isLive: true,
                withCredentials: false
            };

            var element = document.getElementById('videoElement');
            if (player != null) {
                player.unload();
                player.detachMediaElement();
                player.destroy();
                player = null;
            }

            try {
                player = mpegts.createPlayer(mediaDataSource, {
                    enableWorker: true,
                    lazyLoadMaxDuration: 3 * 60,
                    seekType: 'range',
                    liveBufferLatencyChasing: true
                });

                player.attachMediaElement(element);
                player.load();
                
                player.play().catch(e => {
                    console.log("Autoplay blocked. User interaction required.");
                });

            } catch (e) {
                console.error("Engine initialization failed", e);
            }
        }

        function loadSettings() {
            var sURL = document.getElementById('sURL');
            if (sURL) {
                const urlParams = new URLSearchParams(window.location.search);
                const urlParamValue = urlParams.get('url');
                
                if (urlParamValue) {
                    sURL.value = decodeURIComponent(urlParamValue);
                } else {
                    sURL.value = ls_get('sURL', sURL.value);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            loadSettings();
            player_load();
        });
    </script>
</body>
</html>
