<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No-Buffer Stream Player</title>
    <script src="https://cdn.jsdelivr.net/npm/mpegts.js@latest/dist/mpegts.min.js"></script>
    <style>
        :root {
            --primary-color: #003399;
            --bg-color: #0a0a0a;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            overflow: hidden;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 960px;
            aspect-ratio: 16 / 9;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        video {
            width: 100%;
            height: 100%;
            display: block;
        }

        #loadingOverlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #vs_player_tap_unmute {
            position: absolute;
            bottom: 70px;
            left: 25px;
            z-index: 201;
            height: 40px;
            width: 170px;
            background-color: var(--primary-color);
            color: #fff;
            border: 0;
            border-radius: 25px;
            font-weight: bold;
            font-variant-caps: small-caps;
            font-size: 16px;
            cursor: pointer;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        #debugStats {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 12px;
            font-size: 11px;
            border-radius: 4px;
            pointer-events: none;
            display: none;
            z-index: 300;
            min-width: 150px;
            line-height: 1.5;
        }

        .stat-row { display: flex; justify-content: space-between; gap: 10px; }
        .stat-label { color: #aaa; }

        .controls-hint {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 11px;
            color: rgba(255,255,255,0.4);
        }
    </style>
</head>
<body onclick="MvnPlayer.ForceInteraction()">

    <div class="video-container">
        <video id="MvnHlsPlayerLive" playsinline autoplay></video>

        <div id="loadingOverlay">
            <div class="spinner"></div>
            <div id="statusText">Adjusting bits and bytes...</div>
        </div>

        <button id="vs_player_tap_unmute">Tap to unmute</button>

        <div id="debugStats">
            <div class="stat-row"><span class="stat-label">Buffer:</span> <span id="statBuffer">0.00</span>s</div>
            <div class="stat-row"><span class="stat-label">Latency Chasing:</span> <span id="statChase">Active</span></div>
            <div class="stat-row"><span class="stat-label">Resolution:</span> <span id="statRes">-</span></div>
            <div class="stat-row"><span class="stat-label">Speed:</span> <span id="statSpeed">1.0x</span></div>
        </div>

        <div class="controls-hint">Press 'D' for Stats | Stream: live_kofq</div>
    </div>

    <script>
        const STREAM_URL = 'https://stream-cdn-iad3.vaughnsoft.net/play/live_thebunnyhole.flv';
        
        const MvnPlayer = {
            player: null,
            video: document.getElementById('MvnHlsPlayerLive'),
            unmuteBtn: document.getElementById('vs_player_tap_unmute'),
            hasInteracted: false,
            isManuallyPaused: false,

            init() {
                if (!mpegts.getFeatureList().mseLivePlayback) return;

                // AGGRESSIVE LOW-LATENCY CONFIGURATION
                this.player = mpegts.createPlayer({
                    type: 'flv',
                    isLive: true,
                    url: STREAM_URL,
                }, {
                    enableWorker: true,
                    enableStashBuffer: false,        // Kill local browser cache
                    stashInitialSize: 64,            // Start faster
                    autoCleanupSourceBuffer: true,   // Clear memory
                    liveBufferLatencyChasing: true,  // Enable built-in catchup
                    liveBufferLatencyMaxLatency: 1.5, // Max delay allowed before chasing
                    liveBufferLatencyMinLatency: 0.8, // Target latency
                    lazyLoad: false
                });

                this.player.attachMediaElement(this.video);
                this.player.load();
                
                this.setupListeners();
                this.attemptAutoplay();
                this.startSyncLoop();
            },

            setupListeners() {
                this.player.on(mpegts.Events.ERROR, (e) => {
                    console.log("Stream error, reconnecting...");
                    this.reconnect();
                });

                this.player.on(mpegts.Events.MEDIA_INFO, (info) => {
                    document.getElementById('statRes').innerText = info.width + 'x' + info.height;
                });

                this.video.addEventListener('playing', () => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                });

                this.video.addEventListener('pause', () => {
                    // Check if stuck or manually paused
                    setTimeout(() => {
                        if (this.video.paused && !this.isManuallyPaused) {
                            this.reconnect();
                        }
                    }, 3000);
                });
            },

            async attemptAutoplay() {
                this.video.muted = false;
                this.video.volume = 1.0;

                try {
                    await this.player.play();
                } catch (err) {
                    this.video.muted = true;
                    this.player.play();
                    this.unmuteBtn.style.display = 'block';
                }
            },

            ForceInteraction() {
                if (this.hasInteracted) return;
                this.hasInteracted = true;
                this.video.muted = false;
                this.unmuteBtn.style.display = 'none';
                this.player.play().catch(() => {});
            },

            reconnect() {
                if (this.player) {
                    this.player.unload();
                    this.player.detachMediaElement();
                    this.player.destroy();
                }
                document.getElementById('loadingOverlay').style.display = 'flex';
                this.init();
            },

            startSyncLoop() {
                // HIGH FREQUENCY SYNC (Matches original site's aggressive logic)
                setInterval(() => {
                    if (!this.player || this.video.paused) return;

                    try {
                        const buffered = this.video.buffered;
                        if (buffered.length > 0) {
                            const end = buffered.end(buffered.length - 1);
                            const current = this.video.currentTime;
                            const diff = end - current;

                            document.getElementById('statBuffer').innerText = diff.toFixed(2);

                            // AGGRESSIVE LATENCY CATCHUP
                            if (diff > 2.0) {
                                // Hard jump to live edge
                                this.video.currentTime = end - 0.3;
                                document.getElementById('statSpeed').innerText = "JUMP";
                            } else if (diff > 1.2) {
                                // Subtle speed increase (1.1x) to catch up smoothly
                                this.video.playbackRate = 1.1;
                                document.getElementById('statSpeed').innerText = "1.1x";
                            } else {
                                this.video.playbackRate = 1.0;
                                document.getElementById('statSpeed').innerText = "1.0x";
                            }
                        }
                    } catch (e) {}
                }, 300);
            }
        };

        // UI Event Listeners
        MvnPlayer.unmuteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            MvnPlayer.ForceInteraction();
        });

        window.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'd') {
                const debug = document.getElementById('debugStats');
                debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // Jump to live immediately when tab becomes visible
                if (MvnPlayer.video.buffered.length > 0) {
                    MvnPlayer.video.currentTime = MvnPlayer.video.buffered.end(0) - 0.3;
                }
            }
        });

        window.addEventListener('DOMContentLoaded', () => MvnPlayer.init());
    </script>
</body>
</html>
