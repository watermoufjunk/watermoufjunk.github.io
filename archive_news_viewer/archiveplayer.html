<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archive Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=JetBrains+Mono:wght@500;700&display=swap');
        
        :root {
            --bg-main: #0b0f1a;
            --bg-card: #0f172a;
            --accent: #2563eb;
            --text-muted: #64748b;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: #f8fafc; overflow-x: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        #search-view { height: calc(100vh - 80px); overflow-y: auto; }

        .player-viewport {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            max-width: 1100px; 
            margin: 0 auto;
        }

        .player-container {
            width: 100%;
            aspect-ratio: 16 / 9;
            background: #000;
            border-radius: 12px;
            overflow: hidden; 
            border: 1px solid #1e293b;
            flex-shrink: 0;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center; 
            justify-content: center;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        video { width: 100%; height: 100%; object-fit: contain; background: black; cursor: pointer; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--bg-main); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .interactive-btn {
            background: #1e293b;
            border: 1px solid #334155;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .interactive-btn:hover { background: #475569; }

        .progress-container { height: 10px; background: #1e293b; border-radius: 5px; cursor: pointer; position: relative; }
        .progress-fill { height: 100%; background: #2563eb; width: 0%; border-radius: 5px; transition: width 0.1s linear; }

        .api-address-bar {
            background: #020617;
            border: 1px solid #1e293b;
            border-radius: 12px;
            padding: 10px 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: #94a3b8;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .noise-item { opacity: 0.35; filter: grayscale(0.5); }
        .hide-noise .noise-item { display: none !important; }
        
        .thumb-overlay-gradient {
            background: linear-gradient(0deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.4) 50%, rgba(0,0,0,0) 90%);
        }

        .poster-img { transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .group:hover .poster-img { transform: scale(1.08); }

        .video-overlay-btn {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .video-overlay-btn:hover {
            background: rgba(37, 99, 235, 1);
            transform: scale(1.1);
        }
    </style>
</head>
<body class="h-screen flex flex-col hide-noise">

    <header id="main-header" class="flex-shrink-0 bg-slate-900 border-b border-slate-800 p-4 z-50">
        <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-3 cursor-pointer" onclick="location.reload()">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" class="text-white"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                </div>
                <h1 class="text-lg font-black tracking-tighter uppercase">ARCHIVE<span class="text-blue-500">EXPLORER</span></h1>
            </div>

            <div class="flex-1 max-w-md">
                <input type="text" id="searchInput" placeholder="Search news, dates, shows..." onkeydown="if(event.key==='Enter') resetAndSearch()" 
                    class="w-full bg-slate-800 border border-slate-700 rounded-full py-2 px-6 focus:ring-2 focus:ring-blue-500 outline-none text-sm text-white">
            </div>

            <div class="flex items-center gap-2">
                <button id="noise-toggle" onclick="toggleNoiseFilter()" class="interactive-btn text-amber-400 border-amber-900/30">
                    Clean Feed: ON
                </button>
                <select id="showFilterDropdown" onchange="applyShowFilter()" class="interactive-btn bg-slate-800 border-slate-700 max-w-[140px] truncate outline-none cursor-pointer">
                    <option value="ALL">All Shows</option>
                </select>
                <button onclick="toggleDropdown()" class="interactive-btn">Stations</button>
                <button onclick="resetAndSearch()" class="interactive-btn bg-blue-600 border-blue-600">Scan</button>

                <div id="channel-dropdown" class="hidden absolute right-4 top-20 w-64 bg-slate-900 border border-slate-700 rounded-xl shadow-2xl p-4 z-[999]">
                    <div class="flex items-center justify-between mb-3 text-[10px] font-black uppercase text-slate-500">
                        <span>Stations</span>
                        <div class="flex gap-2">
                            <button onclick="setAllChannels(true)" class="text-blue-500">All</button>
                            <button onclick="setAllChannels(false)" class="text-slate-400">None</button>
                        </div>
                    </div>
                    <div id="network-options" class="space-y-1 max-h-60 overflow-y-auto custom-scrollbar"></div>
                </div>
            </div>
        </div>
    </header>

    <main id="search-view" class="flex-1 custom-scrollbar">
        <div class="max-w-[1600px] mx-auto p-6">
            <div class="api-address-bar">
                <div class="flex items-center gap-2 shrink-0">
                    <span class="text-blue-500 font-black px-2 py-0.5 bg-blue-500/10 rounded text-[10px]">GET</span>
                    <span class="text-slate-600 font-bold text-[10px]">v1/search</span>
                </div>
                <div id="current-api-url" class="truncate opacity-90 text-slate-400 select-all cursor-text">
                    Waiting for engine...
                </div>
                <button onclick="copyApiUrl()" class="ml-auto hover:text-white transition-colors" title="Copy URL">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                </button>
            </div>
            <div id="results-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-6"></div>
            <div id="loader" class="py-20 text-center hidden">
                <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-blue-500/20 border-t-blue-500"></div>
            </div>
            <div id="pagination" class="mt-8 flex justify-center hidden">
                <button onclick="loadMore()" class="interactive-btn px-10 py-3">Load More Results</button>
            </div>
        </div>
    </main>

    <main id="player-view" class="fixed inset-0 z-[100] bg-slate-950 hidden">
        <div class="player-viewport">
            <div class="flex justify-between items-center mb-4">
                <button onclick="history.back()" class="bg-slate-900 border border-slate-700 px-4 py-2 rounded-xl text-[11px] font-black uppercase tracking-widest text-slate-300 hover:text-white hover:bg-slate-800 transition-all flex items-center gap-2 group">
                    <svg class="w-4 h-4 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M15 19l-7-7 7-7"/></svg>
                    <span>Go Back</span>
                </button>
                
                <a id="archive-source-link" href="#" target="_blank" class="bg-slate-900 border border-slate-700 px-4 py-2 rounded-xl text-[11px] font-black uppercase tracking-widest text-slate-300 hover:text-white hover:border-blue-500 hover:bg-slate-800 transition-all flex items-center gap-2">
                    <span>Open archive.org source</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                </a>
            </div>

            <div class="flex-1 flex flex-col min-h-0 overflow-y-auto custom-scrollbar pb-10">
                <div class="player-container group" id="vid-wrap">
                    <video id="native-player" crossorigin="anonymous" playsinline onclick="togglePlayPause()"></video>
                    
                    <div class="absolute inset-0 pointer-events-none group-hover:opacity-100 opacity-0 transition-opacity flex items-center justify-center">
                         <button onclick="togglePlayPause()" class="pointer-events-auto bg-blue-600/80 backdrop-blur-md p-6 rounded-full scale-75 group-hover:scale-100 transition-all">
                             <svg id="overlay-play-icon" class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                             <svg id="overlay-pause-icon" class="w-10 h-10 text-white hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                         </button>
                    </div>

                    <div class="absolute bottom-4 right-4 flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="toggleFullscreen()" class="video-overlay-btn pointer-events-auto" title="Fullscreen">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
                        </button>
                    </div>
                </div>

                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5 space-y-6">
                    <div class="space-y-3">
                        <div class="progress-container" onclick="handleSeek(event)">
                            <div id="global-progress" class="progress-fill"></div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4 flex-1 truncate">
                                <button onclick="togglePlayPause()" class="text-white hover:text-blue-500 transition-colors">
                                    <svg id="ctrl-play-icon" class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                    <svg id="ctrl-pause-icon" class="w-10 h-10 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                </button>
                                <div class="truncate">
                                    <h2 id="p-title" class="text-lg font-black text-white uppercase tracking-tighter truncate"></h2>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span id="p-channel" class="bg-blue-600 px-1.5 py-0.5 rounded text-[9px] font-black text-white uppercase"></span>
                                        <span id="p-date-ui" class="text-[11px] font-bold text-blue-400 mono italic"></span>
                                        <span id="p-time-ui" class="text-[11px] font-bold text-slate-500 mono"></span>
                                    </div>
                                </div>
                            </div>
                            <div id="timestamp-ui" class="text-[11px] font-black text-slate-400 mono bg-black/50 px-3 py-1.5 rounded-lg border border-slate-800">00:00:00</div>
                        </div>
                    </div>

                    <div class="border-t border-slate-800 pt-5">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Jump to Segment</span>
                        </div>
                        <div id="seg-list" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const CONFIG = {
            API_SEARCH: 'https://archive.org/advancedsearch.php',
            API_META: 'https://archive.org/metadata/',
            DL_BASE: 'https://archive.org/download/',
            POSTER_JSON: 'https://raw.githubusercontent.com/watermoufjunk/watermoufjunk.github.io/refs/heads/main/archive_news_player/test.json',
            SEGMENT_LENGTH: 300,
            PAGE_SIZE: 100,
            STATIONS: {
                "CNNW": "CNN", "FOXNEWSW": "FOX NEWS", "MSNOW": "MS NBC", "CNBC": "CNBC", 
                "BLOOMBERG": "BLOOMBERG", "FBC": "FOX BIZ", "COM": "COMEDY", 
                "KNTV": "NBC", "KGO": "ABC", "KPIX": "CBS", "KQED": "PBS"
            }
        };

        const state = { 
            page: 1, 
            video: null,
            activeId: null, 
            duration: 0, 
            currentStart: 0, 
            file: null, 
            allItems: [],
            filterNoise: true,
            posters: {},
            isPlayerOpen: false
        };

        window.onload = async () => {
            state.video = document.getElementById('native-player');
            setupPlayerEvents();
            renderStations();
            await loadPosterArt();
            resetAndSearch();

            // Handle browser back button
            window.onpopstate = (event) => {
                if (state.isPlayerOpen) {
                    closePlayer(false); // Close without triggering history again
                }
            };
        };

        async function loadPosterArt() {
            try {
                const response = await fetch(CONFIG.POSTER_JSON);
                const text = await response.text();
                const cleaned = text.replace(/\/\*[\s\S]*?\*\/|([^:]|^)\/\/.*$/gm, '');
                const data = JSON.parse(cleaned);
                data.forEach(item => {
                    if (item.show && item.posters && Array.isArray(item.posters)) {
                        state.posters[item.show.toLowerCase()] = item.posters;
                    }
                });
            } catch (e) { console.error("Posters load error", e); }
        }

        function handleImageError(img, showName, currentIndex, archiveId) {
            const urls = state.posters[showName.toLowerCase()];
            const nextIndex = currentIndex + 1;
            if (urls && urls[nextIndex]) {
                img.src = urls[nextIndex];
                img.onerror = () => handleImageError(img, showName, nextIndex, archiveId);
            } else {
                img.src = `https://archive.org/services/img/${archiveId}`;
                img.classList.add('opacity-60');
                img.onerror = null;
            }
        }

        function parseMeta(fullTitle) {
            const parts = fullTitle.split(/\s*:\s*/);
            const showName = (parts[0] || "Unknown Show").trim();
            const stationPart = (parts[1] || "").trim();
            const metaBlock = parts.slice(2).join(" : ").trim();
            const stationId = stationPart.split(' ')[0].replace('TV-', '');
            const channelLabel = CONFIG.STATIONS[stationId] || "TV";
            const lowTitle = fullTitle.toLowerCase();
            const noiseKeywords = ["bay area", "bay news", "abc7", "news at"];
            const isNoise = (channelLabel === "TV") || noiseKeywords.some(keyword => lowTitle.includes(keyword));

            let dateStr = "UNDATED";
            let timeStr = "";
            if (metaBlock) {
                const dateMatch = metaBlock.match(/^[a-zA-Z]+\s+\d{1,2},\s+\d{4}/);
                if (dateMatch) {
                    dateStr = dateMatch[0];
                    timeStr = metaBlock.replace(dateStr, "").trim();
                } else { dateStr = metaBlock; }
            }

            return { show: showName, channel: channelLabel, date: dateStr.toUpperCase(), time: timeStr.toUpperCase() || "LIVE", isNoise: isNoise };
        }

        function renderStations() {
            const container = document.getElementById('network-options');
            container.innerHTML = '';
            Object.entries(CONFIG.STATIONS).forEach(([id, name]) => {
                const div = document.createElement('label');
                div.className = "flex items-center justify-between p-2 hover:bg-slate-800 rounded-lg cursor-pointer";
                div.innerHTML = `<span class="text-[11px] font-bold text-slate-400 uppercase">${name}</span>
                                 <input type="checkbox" value="TV-${id}" checked onchange="resetAndSearch()" class="station-cb w-4 h-4 accent-blue-600">`;
                container.appendChild(div);
            });
        }

        const resetAndSearch = () => { state.page = 1; state.allItems = []; search(); };
        const loadMore = () => { state.page++; search(true); };

        async function search(append = false) {
            const grid = document.getElementById('results-grid');
            const loader = document.getElementById('loader');
            const pag = document.getElementById('pagination');
            if (!append) { grid.innerHTML = ''; pag.classList.add('hidden'); }
            loader.classList.remove('hidden');
            
            const term = document.getElementById('searchInput').value.trim();
            const channels = Array.from(document.querySelectorAll('.station-cb:checked')).map(c => `collection:${c.value}`);
            
            if (channels.length === 0) {
                loader.classList.add('hidden');
                grid.innerHTML = '<div class="col-span-full py-20 text-center text-slate-500 uppercase font-black tracking-widest text-xs">No stations selected</div>';
                return;
            }

            let q = `mediatype:movies AND (${channels.join(" OR ")})`;
            if (term) q += ` AND (title:(${term}) OR description:(${term}))`;
            
            const params = new URLSearchParams({ 
                q, 
                'fl[]': ['identifier', 'title', 'date', 'publicdate'], 
                sort: 'publicdate desc', 
                rows: CONFIG.PAGE_SIZE, 
                page: state.page, 
                output: 'json' 
            });
            
            const fullUrl = `${CONFIG.API_SEARCH}?${params}`;
            document.getElementById('current-api-url').innerText = fullUrl;
            
            try {
                const res = await fetch(fullUrl);
                const data = await res.json();
                if (data?.response?.docs) {
                    renderItems(data.response.docs);
                    if (data.response.docs.length >= CONFIG.PAGE_SIZE) pag.classList.remove('hidden');
                }
            } catch (e) { console.error("Search failed", e); } 
            finally { loader.classList.add('hidden'); }
        }

        function renderItems(docs) {
            const grid = document.getElementById('results-grid');
            docs.forEach(doc => {
                const m = parseMeta(doc.title);
                state.allItems.push({ doc, meta: m });
                const customPosters = state.posters[m.show.toLowerCase()];
                const initialPoster = (customPosters && customPosters[0]) || `https://archive.org/services/img/${doc.identifier}`;
                const isCustom = !!(customPosters && customPosters[0]);

                const card = document.createElement('div');
                card.className = `group cursor-pointer flex flex-col ${m.isNoise ? 'noise-item' : 'primary-item'}`;
                card.setAttribute('data-show-name', m.show);
                card.innerHTML = `
                    <div class="relative aspect-[16/9] rounded-xl overflow-hidden border border-slate-800 bg-slate-900">
                        <div class="img-slot w-full h-full"></div>
                        <div class="absolute inset-0 thumb-overlay-gradient"></div>
                        <div class="absolute top-2 left-2">
                            <span class="bg-blue-600 px-1.5 py-0.5 rounded text-[8px] font-black text-white uppercase tracking-tight">${m.channel}</span>
                        </div>
                        <div class="absolute top-2 right-2">
                            <span class="bg-black/80 backdrop-blur-md border border-white/10 px-2 py-0.5 rounded text-[8px] font-black text-slate-100 mono uppercase tracking-tighter shadow-xl">
                                ${m.time}
                            </span>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 p-3">
                            <h4 class="text-sm font-black text-white uppercase leading-tight line-clamp-2">${m.show}</h4>
                            <div class="text-[10px] font-bold text-slate-400 mt-1 mono italic opacity-80">${m.date}</div>
                        </div>
                    </div>
                `;
                const img = document.createElement('img');
                img.src = initialPoster;
                img.className = `poster-img w-full h-full object-cover ${isCustom ? 'opacity-100' : 'opacity-60'} group-hover:opacity-100 transition-all`;
                if (isCustom) img.onerror = () => handleImageError(img, m.show, 0, doc.identifier);
                card.querySelector('.img-slot').appendChild(img);
                card.onclick = () => openPlayer(doc.identifier, doc.title);
                grid.appendChild(card);
            });
            updateShowDropdown();
        }

        function copyApiUrl() {
            const text = document.getElementById('current-api-url').innerText;
            const dummy = document.createElement("input");
            document.body.appendChild(dummy);
            dummy.value = text;
            dummy.select();
            document.execCommand("copy");
            document.body.removeChild(dummy);
            const btn = document.querySelector('.api-address-bar button');
            btn.innerHTML = '<span class="text-[8px] text-green-500 font-bold uppercase">Copied!</span>';
            setTimeout(() => {
                btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>';
            }, 2000);
        }

        function updateShowDropdown() {
            const dropdown = document.getElementById('showFilterDropdown');
            const currentVal = dropdown.value;
            dropdown.innerHTML = '<option value="ALL">All Shows</option>';
            const visibleShows = new Set();
            state.allItems.forEach(item => {
                if (!state.filterNoise || !item.meta.isNoise) visibleShows.add(item.meta.show);
            });
            Array.from(visibleShows).sort().forEach(show => {
                const opt = document.createElement('option');
                opt.value = show; opt.innerText = show;
                dropdown.appendChild(opt);
            });
            dropdown.value = visibleShows.has(currentVal) ? currentVal : "ALL";
        }

        function applyShowFilter() {
            const selected = document.getElementById('showFilterDropdown').value;
            document.querySelectorAll('#results-grid > div').forEach(card => {
                const matches = selected === "ALL" || card.getAttribute('data-show-name') === selected;
                card.style.display = matches ? '' : 'none';
            });
        }

        function setAllChannels(val) {
            document.querySelectorAll('.station-cb').forEach(cb => cb.checked = val);
            resetAndSearch();
        }

        const toggleDropdown = () => document.getElementById('channel-dropdown').classList.toggle('hidden');
        
        function toggleNoiseFilter() {
            state.filterNoise = !state.filterNoise;
            document.body.classList.toggle('hide-noise');
            document.getElementById('noise-toggle').innerText = state.filterNoise ? "Clean Feed: ON" : "Clean Feed: OFF";
            updateShowDropdown();
            applyShowFilter();
        }

        async function openPlayer(id, title) {
            state.activeId = id;
            state.isPlayerOpen = true;
            
            // Push history state so back button works as expected
            history.pushState({ playerOpen: true }, "");

            const m = parseMeta(title);
            document.getElementById('player-view').classList.remove('hidden');
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('p-title').innerText = m.show;
            document.getElementById('p-channel').innerText = m.channel;
            document.getElementById('p-date-ui').innerText = m.date;
            document.getElementById('p-time-ui').innerText = m.time;
            
            const sourceLink = document.getElementById('archive-source-link');
            sourceLink.href = `https://archive.org/details/${id}`;

            try {
                const res = await fetch(`${CONFIG.API_META}${id}`);
                const data = await res.json();
                const videoFile = data.files.find(f => f.name.endsWith('.mp4') && !f.name.includes('thumb'));
                if (!videoFile) return;
                state.file = videoFile.name;
                state.duration = parseInt(videoFile.length || 3600);
                const segList = document.getElementById('seg-list');
                segList.innerHTML = '';
                for (let min = 0; min <= Math.floor(state.duration/60); min += 5) {
                    const btn = document.createElement('button');
                    btn.className = "px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-700 text-[10px] font-black text-slate-400 mono hover:border-blue-500 hover:text-white transition-all";
                    btn.innerText = `${min}m`;
                    btn.onclick = () => playSeg(min * 60, 0);
                    segList.appendChild(btn);
                }
                playSeg(0, 0);
            } catch (e) { console.error(e); }
        }

        function playSeg(startSeconds, offsetInSegment = 0) {
            state.currentStart = startSeconds;
            const endSeconds = Math.min(startSeconds + CONFIG.SEGMENT_LENGTH, state.duration);
            const source = `${CONFIG.DL_BASE}${state.activeId}/${encodeURIComponent(state.file)}?start=${startSeconds}&end=${endSeconds}`;
            
            if (state.video.src !== source) {
                state.video.src = source;
                state.video.load();
                
                const seekToOffset = () => {
                    state.video.currentTime = offsetInSegment;
                    state.video.play().catch(() => {});
                    state.video.removeEventListener('loadedmetadata', seekToOffset);
                };
                state.video.addEventListener('loadedmetadata', seekToOffset);
            } else {
                state.video.currentTime = offsetInSegment;
            }
            updatePlayPauseUI(true);
        }

        function togglePlayPause() {
            if (state.video.paused) {
                state.video.play();
                updatePlayPauseUI(true);
            } else {
                state.video.pause();
                updatePlayPauseUI(false);
            }
        }

        function updatePlayPauseUI(isPlaying) {
            const elements = [
                ['overlay-play-icon', 'overlay-pause-icon'],
                ['ctrl-play-icon', 'ctrl-pause-icon']
            ];
            elements.forEach(([playId, pauseId]) => {
                document.getElementById(playId).classList.toggle('hidden', isPlaying);
                document.getElementById(pauseId).classList.toggle('hidden', !isPlaying);
            });
        }

        function toggleFullscreen() {
            const wrap = document.getElementById('vid-wrap');
            if (!document.fullscreenElement) {
                wrap.requestFullscreen().catch(err => console.log(err));
            } else {
                document.exitFullscreen();
            }
        }

        function setupPlayerEvents() {
            state.video.addEventListener('timeupdate', () => {
                const currentGlobal = state.currentStart + state.video.currentTime;
                const progress = (currentGlobal / state.duration) * 100;
                const fill = document.getElementById('global-progress');
                if (fill) fill.style.width = `${progress}%`;
                const ts = document.getElementById('timestamp-ui');
                if (ts) ts.innerText = formatTime(currentGlobal);
            });
        }

        function closePlayer(triggerHistory = true) { 
            state.video.pause(); 
            state.video.src = "";
            state.isPlayerOpen = false;
            document.getElementById('player-view').classList.add('hidden');
            document.getElementById('main-header').classList.remove('hidden');
            
            // If the user clicked the UI "Go Back" button, we need to pop the state manually
            if (triggerHistory && history.state?.playerOpen) {
                history.back();
            }
        }

        const formatTime = (s) => {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = Math.floor(s % 60);
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        };

        function handleSeek(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            const absoluteSeconds = state.duration * pct;
            const segmentStart = Math.floor(absoluteSeconds / CONFIG.SEGMENT_LENGTH) * CONFIG.SEGMENT_LENGTH;
            const offsetInSegment = absoluteSeconds - segmentStart;
            playSeg(segmentStart, offsetInSegment);
        }
    </script>
</body>
</html>
