<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple M3U & API Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add HLS.js for .m3u8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        .channel-card:hover .play-overlay { opacity: 1; }
        .active-filter { background-color: #2563eb !important; color: white !important; }
        video { background: #000; border-radius: 0.5rem; }
        .log-entry:last-child { border-bottom: none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">Stream Center Tester</h1>
                <p class="text-gray-400">Test M3U playlists via URL parameters, manual input, or file upload.</p>
            </div>
            <div class="flex gap-2">
                <label class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg cursor-pointer transition border border-gray-700">
                    <span>Upload M3U</span>
                    <input type="file" id="fileInput" accept=".m3u,.m3u8" class="hidden">
                </label>
            </div>
        </header>

        <!-- Input Section -->
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 mb-6">
            <h2 class="text-sm font-bold text-blue-400 uppercase mb-4 tracking-wider">Load M3U Playlist</h2>
            <p class="text-xs text-gray-500 mb-4 italic">Tip: You can auto-load by adding <b>?url=[YOUR_M3U_URL]</b> to the page address.</p>
            <div class="flex flex-col md:flex-row gap-3">
                <div class="flex-grow">
                    <label class="block text-xs font-medium mb-1 text-gray-500">Remote Playlist URL</label>
                    <input type="text" id="urlInput" placeholder="https://example.com/playlist.m3u" 
                        class="w-full bg-gray-900 border border-gray-600 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                </div>
                <div class="flex items-end">
                    <button onclick="loadFromUrl()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 px-8 py-2 rounded-lg text-sm font-bold transition">Load</button>
                </div>
            </div>
        </div>

        <!-- Activity Log Section -->
        <div class="mb-8 bg-gray-800/50 rounded-xl border border-gray-700 overflow-hidden">
            <div class="bg-gray-800 px-4 py-2 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xs font-bold uppercase tracking-wider text-gray-400">Session Activity Log</h3>
                <button onclick="clearLog()" class="text-[10px] text-gray-500 hover:text-white uppercase">Clear Log</button>
            </div>
            <div id="activityLog" class="max-h-32 overflow-y-auto text-xs font-mono p-2">
                <div class="text-gray-600 italic px-2 py-1">No activity yet.</div>
            </div>
        </div>

        <!-- Video Player Section -->
        <div id="playerContainer" class="hidden mb-8 bg-black rounded-xl p-4 border border-gray-700">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
                <div class="flex flex-col truncate w-full">
                    <span id="nowPlaying" class="font-bold text-blue-400 truncate text-lg"></span>
                    <span id="nowPlayingUrl" class="text-[10px] text-gray-500 truncate mb-1"></span>
                    <div id="headerHints" class="flex flex-wrap gap-2 mt-1"></div>
                </div>
                <div class="flex gap-2 shrink-0">
                    <a id="playerOpenTab" href="#" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                        Open in New Tab
                    </a>
                    <button onclick="closePlayer()" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-3 py-1.5 rounded-lg text-sm font-medium transition">
                        Close
                    </button>
                </div>
            </div>
            <video id="videoPlayer" controls class="w-full max-h-[600px]"></video>
            <div id="hlsNotice" class="hidden mt-2 p-2 bg-yellow-900/30 border border-yellow-700/50 rounded text-[10px] text-yellow-200">
                Note: This stream requires specific headers (Referer/UA) to play. If it fails here, use "Open in New Tab" with a specialized player or extension.
            </div>
        </div>

        <!-- Filters & Search -->
        <div class="mb-6 flex flex-col md:flex-row gap-4">
            <div class="flex-grow relative">
                <input type="text" id="searchInput" oninput="filterChannels()" placeholder="Search channels..." 
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 pl-10 outline-none focus:border-blue-500">
                <span class="absolute left-3 top-3.5 text-gray-500">üîç</span>
            </div>
            <select id="categoryFilter" onchange="filterChannels()" 
                class="bg-gray-800 border border-gray-700 rounded-lg p-3 outline-none focus:border-blue-500 min-w-[200px]">
                <option value="all">All Categories</option>
            </select>
        </div>

        <!-- Channel Grid -->
        <div id="channelGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
            <div class="col-span-full py-20 text-center text-gray-500">
                No channels loaded. Load a URL or upload a file.
            </div>
        </div>
    </div>

    <script>
        let allChannels = [];
        let hlsInstance = null;
        const proxy = "https://corsproxy.io/?";

        // Initialization: Check for URL parameters on load
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const m3uUrl = params.get('url') || params.get('m3u');
            
            if (m3uUrl) {
                document.getElementById('urlInput').value = m3uUrl;
                loadFromUrl(m3uUrl);
            }
        };

        function addToLog(source, type = 'info') {
            const logContainer = document.getElementById('activityLog');
            if (logContainer.innerText.includes("No activity yet")) logContainer.innerHTML = '';
            const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const entry = document.createElement('div');
            entry.className = 'log-entry border-b border-gray-800 py-1 px-2 flex justify-between items-center hover:bg-gray-800 group';
            
            let colorClass = 'text-blue-400';
            if (type === 'file') colorClass = 'text-purple-400';
            if (type === 'error') colorClass = 'text-red-400';

            entry.innerHTML = `
                <div class="truncate mr-4">
                    <span class="text-gray-600 mr-2">[${now}]</span>
                    <span class="${colorClass} break-all font-bold mr-1">${type.toUpperCase()}:</span>
                    <span class="text-gray-300">${source}</span>
                </div>
                <button onclick="copyToClipboard('${source}')" class="opacity-0 group-hover:opacity-100 text-gray-500 hover:text-white transition px-2">Copy</button>
            `;
            logContainer.prepend(entry);
        }

        function clearLog() {
            document.getElementById('activityLog').innerHTML = '<div class="text-gray-600 italic px-2 py-1">No activity yet.</div>';
        }

        function copyToClipboard(text) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            addToLog(file.name, 'file');
            const reader = new FileReader();
            reader.onload = (e) => parseM3U(e.target.result);
            reader.readAsText(file);
        });

        async function loadFromUrl(passedUrl = null) {
            const urlInput = document.getElementById('urlInput');
            const url = passedUrl || urlInput.value.trim();
            
            if (!url) return alert("Enter a URL");
            
            addToLog(url, 'fetching');
            
            try {
                const response = await fetch(proxy + encodeURIComponent(url));
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.text();
                addToLog(url, 'url');
                parseM3U(data);
            } catch (err) {
                addToLog(err.message, 'error');
                alert("Failed to fetch M3U playlist. Ensure the URL is correct and public.");
            }
        }

        function parseM3U(content) {
            const lines = content.split('\n');
            const channels = [];
            const categories = new Set(["Uncategorized"]);
            let tempOptions = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.startsWith('#EXTVLCOPT:')) {
                    tempOptions.push(line.replace('#EXTVLCOPT:', ''));
                    continue;
                }
                if (line.startsWith('#EXTINF:')) {
                    const info = line;
                    let url = "";
                    let nextIdx = i + 1;
                    while (nextIdx < lines.length && (lines[nextIdx].trim().startsWith('#') || lines[nextIdx].trim() === "")) {
                        if (lines[nextIdx].trim().startsWith('#EXTVLCOPT:')) {
                            tempOptions.push(lines[nextIdx].trim().replace('#EXTVLCOPT:', ''));
                        }
                        nextIdx++;
                    }
                    url = lines[nextIdx]?.trim();
                    if (url) {
                        const name = info.split(',').pop() || "Unknown Channel";
                        const logoMatch = info.match(/tvg-logo="([^"]+)"/i);
                        const groupMatch = info.match(/group-title="([^"]+)"/i);
                        const category = groupMatch ? groupMatch[1] : "Uncategorized";
                        categories.add(category);
                        channels.push({
                            name: name,
                            url: url,
                            logo: logoMatch ? logoMatch[1] : null,
                            category: category,
                            options: [...tempOptions]
                        });
                        tempOptions = [];
                        i = nextIdx;
                    }
                }
            }
            allChannels = channels;
            updateCategoryDropdown(Array.from(categories));
            renderChannels(channels);
        }

        function updateCategoryDropdown(categories) {
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="all">All Categories</option>';
            categories.sort().forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat; opt.textContent = cat;
                select.appendChild(opt);
            });
        }

        function renderChannels(channels) {
            const grid = document.getElementById('channelGrid');
            grid.innerHTML = '';
            if (channels.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">No channels found in this playlist.</div>';
                return;
            }
            channels.forEach((ch) => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 rounded-lg p-3 border border-gray-700 flex flex-col items-center text-center transition hover:border-blue-500 h-full';
                const logoHtml = ch.logo 
                    ? `<img src="${ch.logo}" class="h-16 w-full object-contain mb-2 rounded" onerror="this.src='https://via.placeholder.com/150?text=TV'">`
                    : `<div class="h-16 w-full bg-gray-700 flex items-center justify-center rounded mb-2 text-xs font-bold text-gray-500 uppercase">No Logo</div>`;
                
                const hasOptions = ch.options && ch.options.length > 0;

                card.innerHTML = `
                    ${logoHtml}
                    <div class="text-[10px] text-blue-400 uppercase font-bold mb-1 truncate w-full">${ch.category}</div>
                    <div class="text-sm font-medium mb-3 line-clamp-2 h-10 overflow-hidden w-full" title="${ch.name}">${ch.name}</div>
                    ${hasOptions ? '<div class="text-[8px] bg-blue-900/40 text-blue-300 px-1 rounded mb-2 font-mono">HEADER REQD</div>' : ''}
                    <div class="flex flex-col gap-2 w-full mt-auto">
                        <button onclick="playStream('${encodeURIComponent(ch.url)}', '${encodeURIComponent(ch.name)}', '${encodeURIComponent(JSON.stringify(ch.options))}')" 
                            class="bg-blue-600 hover:bg-blue-700 text-xs py-2 rounded transition font-bold">WATCH NOW</button>
                        <a href="${ch.url}" target="_blank" class="bg-gray-700 hover:bg-gray-600 text-xs py-2 rounded transition text-center flex items-center justify-center gap-1">
                            <span>NEW TAB</span>
                        </a>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function filterChannels() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const filtered = allChannels.filter(ch => {
                const matchesSearch = ch.name.toLowerCase().includes(searchTerm);
                const matchesCategory = category === 'all' || ch.category === category;
                return matchesSearch && matchesCategory;
            });
            renderChannels(filtered);
        }

        function playStream(url, name, optionsJson) {
            const video = document.getElementById('videoPlayer');
            const container = document.getElementById('playerContainer');
            const title = document.getElementById('nowPlaying');
            const urlDisplay = document.getElementById('nowPlayingUrl');
            const tabBtn = document.getElementById('playerOpenTab');
            const hints = document.getElementById('headerHints');
            const notice = document.getElementById('hlsNotice');

            const decodedUrl = decodeURIComponent(url);
            const decodedName = decodeURIComponent(name);
            const options = JSON.parse(decodeURIComponent(optionsJson));

            title.innerText = decodedName;
            urlDisplay.innerText = decodedUrl;
            tabBtn.href = decodedUrl;
            hints.innerHTML = '';
            
            if (options.length > 0) {
                notice.classList.remove('hidden');
                options.forEach(opt => {
                    const badge = document.createElement('span');
                    badge.className = "text-[9px] bg-gray-700 text-gray-300 px-1.5 py-0.5 rounded border border-gray-600 font-mono";
                    badge.innerText = opt;
                    hints.appendChild(badge);
                });
            } else {
                notice.classList.add('hidden');
            }
            
            container.classList.remove('hidden');
            
            if (hlsInstance) {
                hlsInstance.destroy();
                hlsInstance = null;
            }

            if (decodedUrl.includes('.m3u8') && Hls.isSupported()) {
                hlsInstance = new Hls();
                hlsInstance.loadSource(decodedUrl);
                hlsInstance.attachMedia(video);
                hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else {
                video.src = decodedUrl;
                video.play().catch(e => console.warn("Native playback failed."));
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function closePlayer() {
            const video = document.getElementById('videoPlayer');
            const container = document.getElementById('playerContainer');
            if (hlsInstance) {
                hlsInstance.destroy();
                hlsInstance = null;
            }
            video.pause();
            video.src = "";
            container.classList.add('hidden');
        }
    </script>
</body>
</html>
